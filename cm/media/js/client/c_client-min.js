Layout=function(){};Layout.prototype={init:function(){},isInFrame:function(){return(!CY.Lang.isUndefined(parent)&&parent.location!=location&&CY.Lang.isFunction(parent.f_getFrameFilterData));},isInComentSite:function(){var b=false;try{if(!CY.Lang.isUndefined(sv_site_url)&&!CY.Lang.isUndefined(parent)&&!CY.Lang.isUndefined(parent.parent)){var a=new String(parent.parent.location);b=(a.indexOf(sv_site_url)==0);}}catch(c){b=false;}return b;},sliderValToPx:function(d){var c=CY.DOM.winWidth();if(this.isInFrame()){c=parent.$(parent).width();}var b=d/100;b=Math.min(b,gConf.sliderFixedMin);b=Math.max(b,gConf.sliderFixedMax);var a=b*c;return Math.floor(a);},getTopICommentsWidth:function(){return this.getTopICommentsWidthFromWidth(this.sliderValToPx(gPrefs.get("layout","comments_col_width")));},iCommentsRequiredThreadPadding:function(){return 2*gConf.iCommentThreadPadding;},getTopICommentsWidthFromWidth:function(b){var a=b-this.iCommentsRequiredThreadPadding();return a-7;},setLeftColumnWidth:function(a){CY.one("#contentcolumn").setStyle("marginLeft",a+"px");CY.one("#leftcolumn").setStyle("width",a+"px");},parentInterfaceUnfreeze:function(){if(this.isInFrame()){parent.f_interfaceUnfreeze();}}};gNoSelectionYet=gettext("No selection yet");gFormHtml={formStart:'<form id="###" onsubmit="return false;">',nameInput:gettext("Username:")+'<center><input id="###" name="name" class="n_name user_input" style="padding:1px;" type="text"></input></center>',emailInput:gettext("E-mail address:")+'<center><input id="###" name="email" class="n_email user_input" style="padding:1px;" type="text"></input></center>',titleInput:gettext("Title:")+'<center><input id="###" name="title" class="n_title comment_input" style="padding:1px;" type="text"></input></center>',contentInput:gettext("Content:")+'<center><textarea id="###" name="content" class="n_content comment_input" rows="10" style="padding:1px;"></textarea></center>',tagsInput:gettext("Tag:")+'<center><input id="###" name="tags" class="n_tags comment_input" style="padding:1px;" type="text"></input></center>',hidden:'<input id="###" class="comment_input" name="???" type="hidden" value=""></input>',formEnd:"</form>",changeScope:'<div id="###">'+gettext("Modify comment's scope:")+'<input type="checkbox" name="change_scope"></input></div>',headerTitle:'<center><div id="###" class="c-header-title"></div></center>',currentSel:'<div id="###">'+gettext("Comment will apply to this selection:")+'<br/><div class="current_sel"><div id="???" class="current_sel_ins">'+gNoSelectionYet+"</div></div>#hiddeninput#</div>",btns:'<center><input id="###" type="button" value="'+gettext("Save")+'" /><input id="???" type="button" value="'+gettext("Cancel")+'" /></center>',closeIcon:'<a id="###" class="c-close" title="'+gettext("close")+'"><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</em></a>'};getHtml=function(e){ret={};ret.headerContent="";if("closeBtnId" in e){ret.headerContent+=gFormHtml.closeIcon.replace("###",e.closeBtnId);}ret.headerContent+=gFormHtml.headerTitle.replace("###",e.formTitleId);var g="";if("changeScopeInputId" in e){g=gFormHtml.changeScope.replace("###",e.changeScopeInputId);}var a="<center>"+gFormHtml.hidden.replace("###",e.selectionPlaceId).replace("???","selection_place")+"</center>";var f=gFormHtml.currentSel.replace("###",e.currentSelId).replace("???",e.currentSelIdI).replace("#hiddeninput#",a);var d=gFormHtml.btns.replace("###",e.addBtnId).replace("???",e.cancelBtnId);var b=gFormHtml.formStart.replace("###",e.formId)+g+f;if("nameInputId" in e){b=b+gFormHtml.nameInput.replace("###",e.nameInputId);}if("emailInputId" in e){b=b+gFormHtml.emailInput.replace("###",e.emailInputId);}b=b+gFormHtml.titleInput.replace("###",e.titleInputId)+gFormHtml.contentInput.replace("###",e.contentInputId);categories=CY.JSON.parse(sv_categories);if(categories.hasOwnProperty("0")){category_options="";for(c in categories){category_options+='<option value="'+c+'">'+categories[c]+"</option>";}gFormHtml.categoryInput=gettext("Category:")+'&nbsp;<select id="###" name="category" class="n_category comment_input" style="padding:1px;" type="text">'+category_options+"</select>";b=b+'<span class="n_category_input">'+gFormHtml.categoryInput.replace("###",e.categoryInputId)+"<br /></span>";}b=b+gFormHtml.tagsInput.replace("###",e.tagsInputId);b=b+gFormHtml.hidden.replace("###",e.formatInputId).replace("???","format");b=b+gFormHtml.hidden.replace("###",e.startWrapperInputId).replace("???","start_wrapper");b=b+gFormHtml.hidden.replace("###",e.endWrapperInputId).replace("???","end_wrapper");b=b+gFormHtml.hidden.replace("###",e.startOffsetInputId).replace("???","start_offset");b=b+gFormHtml.hidden.replace("###",e.endOffsetInputId).replace("???","end_offset");b=b+gFormHtml.hidden.replace("###",e.keyId).replace("???","comment_key");b=b+gFormHtml.hidden.replace("###",e.editCommentId).replace("???","edit_comment_id");b=b+d+gFormHtml.formEnd;ret.bodyContent=b;return ret;};changeFormFieldsWidth=function(e,d){var a=(d-20)+"px";var b=CY.all("#"+e+" input[type='text']");if(b!=null){b.setStyle("width",a);}b=CY.all("#"+e+" textarea");if(b!=null){b.setStyle("width",a);}};addFormErrMsg=function(k,b,d){var a=document.getElementById(k);var g,j,h,f;for(g=0,f=a.elements.length;g<f;++g){j=a.elements[g];if(j.name==b){h=document.createElement("DIV");CY.DOM.addClass(h,"c-error");h.id=j.id+"-err";h.appendChild(document.createTextNode(d));if(j.parentNode.nextSibling){j.parentNode.parentNode.insertBefore(h,j.parentNode.nextSibling);}else{j.parentNode.parentNode.appendChild(h);}}}};removeFormErrMsg=function(b){var a=CY.all("#"+b+" .c-error");if(a!=null){a.each(function(d){d.remove();});}};getWrapperAncestor=function(b){var a=b;while(a!=null){if(CY.DOM.hasClass(a,"c-s")){return a;}a=a.parentNode;}return null;};hasWrapperAncestor=function(a){return(getWrapperAncestor(a)!=null);};getSelectionInfo=function(){var p=null,J=null,D=0,c=0,h="";if(window.getSelection){var u=safari_mobile?storedSelection:window.getSelection();if(u.rangeCount>0){var l=u.getRangeAt(0);h=l.toString();if(h!=""){var C=document.createRange();C.setStart(u.anchorNode,u.anchorOffset);C.collapse(true);var A=document.createRange();A.setEnd(u.focusNode,u.focusOffset);A.collapse(false);var I=(A.compareBoundaryPoints(2,C)==1);p=(I)?u.anchorNode.parentNode:u.focusNode.parentNode;if(p.nodeName=="mi"||p.nodeName=="mo"){p=p.parentElement.parentElement.parentElement.parentElement;}innerStartNode=(I)?u.anchorNode:u.focusNode;J=(I)?u.focusNode.parentNode:u.anchorNode.parentNode;if(J.nodeName=="mi"||J.nodeName=="mo"){J=J.parentElement.parentElement.parentElement.parentElement;}innerEndNode=(I)?u.focusNode:u.anchorNode;D=(I)?u.anchorOffset:u.focusOffset;c=(I)?u.focusOffset:u.anchorOffset;if(!hasWrapperAncestor(J)&&hasWrapperAncestor(p)){var y=document.createRange();y.setStart(innerStartNode,D);var b=getWrapperAncestor(p);var r=b;y.setEndAfter(r);var f=parseInt(b.id.substring("sv_".length));while(y.toString().length<l.toString().length){f++;var t=CY.one("#sv_"+f);if(t){r=CY.Node.getDOMNode(t);y.setEndAfter(r);}else{break;}}J=r.lastChild;c=CY.DOM.getText(J).length;}else{if(!hasWrapperAncestor(p)&&hasWrapperAncestor(J)){var y=document.createRange();y.setEnd(innerEndNode,c);var g=getWrapperAncestor(J);var o=g;y.setStartBefore(o);var f=parseInt(g.id.substring("sv_".length));while(y.toString().length<l.toString().length){f--;var t=CY.one("#sv_"+f);if(t){o=CY.Node.getDOMNode(t);y.setStartBefore(o);}else{break;}}p=o.firstChild;D=0;}else{if(!hasWrapperAncestor(p)&&!hasWrapperAncestor(J)){var n=h.length;var m=[];for(var f=0;;f++){var x=CY.one("#sv_"+f);if(x==null){break;}else{var H=x.get("text");if(h.indexOf(H)==0){m.push(f);}}}var E=[];for(var f=0;;f++){var x=CY.one("#sv_"+f);if(x==null){break;}else{var H=x.get("text");if(h.indexOf(H)==(n-H.length)){E.push(f);}}}var w=false;for(var B=0;B<m.length;B++){for(var z=0;z<E.length;z++){var v=document.createRange();var k=CY.Node.getDOMNode(CY.one("#sv_"+m[B]));var G=CY.Node.getDOMNode(CY.one("#sv_"+E[z]));v.setStartBefore(k);v.setEndAfter(CY.Node.getDOMNode(G));if((-1<v.compareBoundaryPoints(0,l))&&(1>v.compareBoundaryPoints(2,l))){p=k.firstChild;D=0;J=G.lastChild;c=CY.DOM.getText(G).length;w=true;break;}}if(w){break;}}}}}C.detach();A.detach();}else{return null;}}else{return null;}}else{if(document.selection){var d=document.selection.createRange();if(d.text.length==0){return null;}var a=d.parentElement();var q=d.duplicate();var F=d.duplicate();q.collapse(true);F.collapse(false);p=q.parentElement();while(q.moveStart("character",-1)!=0){if(q.parentElement()!=p){break;}D++;}J=F.parentElement();while(F.moveEnd("character",-1)!=0){if(F.parentElement()!=J){break;}c++;}h=d.text;}}if(!hasWrapperAncestor(p)||!hasWrapperAncestor(J)){return null;}return{text:h,start:{elt:p,offset:D},end:{elt:J,offset:c}};};_afterDlg=function(a){var d=a[0];var b=a[1];var c=a[2];d.call(b,c);};_abortNewCommentConfirmed=function(a){if(isICommentFormVisible()){if(gLayout.isInFrame()){gSync.hideICommentForm({fn:function(){_afterDlg(a);}});gSync.resume();}}};_abortNewReplyConfirmed=function(a){if(gNewReplyHost!=null){if(gLayout.isInFrame()){cancelNewReplyForm();_afterDlg(a);}}};_abortNewEditConfirmed=function(a){if(gEditICommentHost!=null){if(gLayout.isInFrame()){cancelEditForm();_afterDlg(a);}}};checkForOpenedDialog=function(c,e,a,b){var d=[];if(c!=null){d=CY.Array.map(gDb.getThreads([gDb.getComment(c.commentId)]),function(f){return f.id;});}if(isICommentFormVisible()||(gNewReplyHost!=null&&(c==null||CY.Array.indexOf(d,gNewReplyHost.commentId)!=-1))||(gEditICommentHost!=null&&(c==null||CY.Array.indexOf(d,gEditICommentHost.commentId)!=-1))){if(gLayout.isInFrame()){if(isICommentFormVisible()){parent.f_yesNoDialog(gettext("New comment will be canceled, continue?"),gettext("Warning"),null,null,null,_abortNewCommentConfirmed,this,[e,a,b]);}else{if(gNewReplyHost!=null){parent.f_yesNoDialog(gettext("Started reply will be canceled, continue?"),gettext("Warning"),null,null,null,_abortNewReplyConfirmed,this,[e,a,b]);}else{if(gEditICommentHost!=null){parent.f_yesNoDialog(gettext("Started comment edition will be canceled, continue?"),gettext("Warning"),null,null,null,_abortNewEditConfirmed,this,[e,a,b]);}}}}}else{e.call(a,[]);}};paintCommentScope=function(b){if(b.reply_to_id==null&&b.start_wrapper!=-1){var a={start:{elt:document.getElementById("sv_"+b.start_wrapper),offset:b.start_offset},end:{elt:document.getElementById("sv_"+b.end_wrapper),offset:b.end_offset}};if(document.getElementById("sv_"+b.start_wrapper)==null){warn_server({from:"paintCommentScope",start_wrapper:b.start_wrapper});}else{if(document.getElementById("sv_"+b.end_wrapper)==null){warn_server({from:"paintCommentScope",end_wrapper:b.end_wrapper});}else{a.start=_convertSelectionFromCSToCC(a.start);a.end=_convertSelectionFromCSToCC(a.end);renderComment(a,b.id);}}}};getCommentIdsFromClasses=function(b){var a=[];var e=b.className.split(" ");for(var d=0,c=e.length;d<c;d++){if(e[d].indexOf("c-id-")==0){a.push(parseInt(e[d].substring("c-id-".length)));}}return a;};renderComment=function(b,d){var f=b.start["offset"];var c=b.end["offset"];var e=b.start["elt"];var a=b.end["elt"];if((e!=null)&&(a!=null)&&_getTextNodeContent(e)!=""&&_getTextNodeContent(a)!=""){markWholeNodesAsComments(e,a,d);markEndsAsComments(e,f,a,c,d);}};markWholeNodesAsComments=function(d,a,b){var c=_findCommonAncestor(d,a);_dynSpanToAnc(d,c,b,false);_dynSpanToAnc(a,c,b,true);_dynSpanInBetween(c,d,a,b);};_setTextNodeContent=function(a,b){CY.DOM.setText(a,b);};_getTextNodeContent=function(a){return CY.DOM.getText(a);};markEndsAsComments=function(d,a,p,j,c){var n=_getTextNodeContent(d).substring(0,a);var l=_getTextNodeContent(d).substring(a);var m=_getTextNodeContent(p).substring(0,j);var g=_getTextNodeContent(p).substring(j);var b=(d===p);if(l!=""){if(CY.DOM.hasClass(d,"c-c")){var f=null,o=null,h=null,i=null;var k=(b)?_getTextNodeContent(d).substring(a,j):l;if(b&&(g!="")){h=d;f=h;}if(k!=""){if(f==null){o=d;}else{o=_yuiCloneNode(d);f.parentNode.insertBefore(o,f);}f=o;}if(n!=""){if(f==null){i=d;}else{i=_yuiCloneNode(d);f.parentNode.insertBefore(i,f);}f=i;}if(h!=null){_setTextNodeContent(h,g);}if(o!=null){_setTextNodeContent(o,k);_addIdClass(o,c);}if(i!=null){_setTextNodeContent(i,n);}}}if((!b)&&(m!="")){if(CY.DOM.hasClass(p,"c-c")){var f=null,e=null,h=null;if(g!=""){h=p;f=p;}if(m!=""){if(f==null){e=p;}else{e=_yuiCloneNode(p);f.parentNode.insertBefore(e,f);}f=e;}if(h!=null){_setTextNodeContent(h,g);}if(e!=null){_addIdClass(e,c);_setTextNodeContent(e,m);}}}};_yuiCloneNode=function(b){var a=CY.Node.getDOMNode(CY.one("#"+b.id).cloneNode(true));a.id=CY.guid();return a;};_dynSpanToAnc=function(d,b,a,f){var g=d;while((g!=null)&&(g!==b)&&(g.parentNode!==b)){var e=null;if(f){e=g.previousSibling;}else{e=g.nextSibling;}if(e==null){g=g.parentNode;}else{g=e;_recAddComment(g,a);}}};_dynSpanInBetween=function(g,h,f,d){var c=h;var b=null;while(c){if(c.parentNode===g){b=c;break;}c=c.parentNode;}if(b!=null){c=f;var e=null;while(c){if(c.parentNode===g){e=c;break;}c=c.parentNode;}if(e!=null){c=b.nextSibling;while((c!=null)&&(c!==e)){_recAddComment(c,d);c=c.nextSibling;}}}};_bruteContains=function(a,b){while(b){if(a===b){return true;}b=b.parentNode;}return false;};_addIdClass=function(b,a){CY.DOM.addClass(b,"c-id-"+a);var c=_findParentBlockElt(b);if(c!=null){_unpaintCategories(c);_repaintCategories(b,c);}_updateCommentCounter(b);};_removeIdClass=function(b,a){CY.DOM.removeClass(b,"c-id-"+a);var c=_findParentBlockElt(b);if(c!=null){_unpaintCategories(c);_repaintCategories(b,c,a);}_updateCommentCounter(b);};_removeIdClasses=function(a){var b=_cgetRegExp("(?:^|\\s+)c-id-(?:\\d+)","g");a.className=a.className.replace(b," ");_updateCommentCounter(a);var c=_findParentBlockElt(a);if(c!=null){_unpaintCategories(c);}};_findParentBlockElt=function(c){var d=c;var a=d.currentStyle||window.getComputedStyle(d,"");var b=a.display;while(d!=null&&b!="block"){d=d.parentElement;a=d.currentStyle||window.getComputedStyle(d,"");b=a.display;}return d;};_unpaintCategories=function(a){CY.DOM.removeClass(a,"cat1");CY.DOM.removeClass(a,"cat2");CY.DOM.removeClass(a,"cat3");CY.DOM.removeClass(a,"cat4");CY.DOM.removeClass(a,"cat5");};_repaintCategories=function(d,f,c){var b=parseInt(getWrapperAncestor(d).id.substr(3));var a=gDb.comments.length;for(var e=0;e<a;e++){if(e in gDb.comments){var g=gDb.comments[e];if((c==null||g.id!=c)&&g.start_wrapper<=b&&g.end_wrapper>=b){if(g.category){CY.DOM.addClass(f,"cat"+g.category);}}}}};_recAddComment=function(b,a){if(CY.DOM.hasClass(b,"c-c")){_addIdClass(b,a);}else{var d=b.firstChild;while(d!=null){_recAddComment(d,a);d=d.nextSibling;}}};_findCommonAncestor=function(c,a){if(_bruteContains(c,a)){return c;}else{var b=a;while((b!=null)&&!_bruteContains(b,c)){b=b.parentNode;}return b;}};_cregexCache={};_cgetRegExp=function(b,a){a=a||"";if(!_cregexCache[b+a]){_cregexCache[b+a]=new RegExp(b,a);}return _cregexCache[b+a];};_updateCommentCounter=function(a){var b=_cgetRegExp("(?:^|\\s+)c-id-(?:\\d+)","g");var d=a.className.match(b);var c=(d==null)?0:gDb.getThreads(CY.Array.map(d,function(e){return gDb.getComment(parseInt(e.replace(/\D/g,"")));})).length;b=_cgetRegExp("(?:^|\\s+)c-count-(?:\\d+)","g");a.className=a.className.replace(b," ");CY.DOM.addClass(a,"c-count-"+c+" ");if(c>0){a.setAttribute("title",c+ngettext(" comment"," comments",c));if(c>25){CY.DOM.addClass(a,"c-count-25");}}};_convertSelectionFromCCToCS=function(b){var d=b.offset;var a=b.elt.parentNode;var c=b.elt.previousSibling;while(c!=null){d+=_getTextNodeContent(c).length;c=c.previousSibling;}return{elt:a,offset:d};};_convertSelectionFromCSToCC=function(d){var c={elt:null,offset:-1};var f=null;var e=d.elt.firstChild;var a=0;while(e!=null){var b=a;a+=_getTextNodeContent(e).length;if(a>=d.offset){c.elt=e;c.offset=d.offset-b;break;}e=e.nextSibling;}return c;};unpaintCommentScope=function(k){var j=k.id;var s="c-id-"+j;var m=[];var r=CY.all("."+s);if(r!=null){for(var h=0,d=r.size();h<d;h++){var q=r.item(h);if(q.hasClass("c-c")){var l=CY.Node.getDOMNode(q);_removeIdClass(l,j);var f=getCommentIdsFromClasses(l);quicksort(f);var a=q.get("previousSibling");if(a!=null){var b=CY.Node.getDOMNode(a);var t=getCommentIdsFromClasses(b);quicksort(t);if(areSortedArraysEqual(f,t)){_setTextNodeContent(l,_getTextNodeContent(b)+_getTextNodeContent(l));m.push(b);}}var e=q.get("nextSibling");if(e!=null){var o=CY.Node.getDOMNode(e);var g=getCommentIdsFromClasses(o);quicksort(g);if(areSortedArraysEqual(f,g)){l.firstChild.data=l.firstChild.data+o.firstChild.data;m.push(o);}}}else{alert("HAS NO c-c ? : "+commentNode.get("id")+" , innerHTML :"+commentNode.get("innerHTML"));return;}}}for(var h=0,d=m.length;h<d;h++){m[h].remove();}};unpaintAllComments=function(){var k=CY.all(".c-s");var f=[];for(var e=0,a=k.size();e<a;e++){var j=k.item(e);var b=j.get("firstChild");var h=CY.Node.getDOMNode(j.get("firstChild"));_removeIdClasses(h);var d=b.get("nextSibling");while(d!=null){var g=CY.Node.getDOMNode(d);h.firstChild.data=h.firstChild.data+g.firstChild.data;f.push(g);d=d.get("nextSibling");}}for(var e=0,a=f.length;e<a;e++){f[e].remove();}};showScope=function(b){var a=CY.all(".c-id-"+b);if(a!=null){a.addClass("c-scope");}};hideScopeAnyway=function(){var a=CY.all(".c-scope");if(a!=null){a.removeClass("c-scope");}};Db=function(){this.comments=null;this.allComments=null;this.commentsByDbId={};this.allCommentsByDbId={};this.ordered_comment_ids={};};Db.prototype={init:function(){this.allComments=CY.JSON.parse(sv_comments);if(sv_read_only){this.initToReadOnly();}this._computeAllCommentsByDbId();this._reorder();},_del:function(a,e,g){var f=e[g];for(var c=0;c<f.replies.length;c++){var d=f.replies[c].id;this._del(f.replies,e,d);c--;}for(var c=0,b=a.length;c<b;c++){if(a[c].id==g){a.splice(c,1);delete e[g];break;}}},del:function(b){var a=(b.reply_to_id==null)?this.comments:this.commentsByDbId[b.reply_to_id].replies;this._del(a,this.commentsByDbId,b.id);a=(b.reply_to_id==null)?this.allComments:this.allCommentsByDbId[b.reply_to_id].replies;this._del(a,this.allCommentsByDbId,b.id);this._reorder();},_reorder:function(){var l=[];for(var g=0,c=this.allComments.length;g<c;g++){var h=this.allComments[g];var p=false;for(var f=0,o=l.length;f<o;f++){var b=l[f];var e=this.allCommentsByDbId[b];if((h.start_wrapper<e.start_wrapper)||((h.start_wrapper==e.start_wrapper)&&(h.start_offset<e.start_offset))||((h.start_wrapper==e.start_wrapper)&&(h.start_offset==e.start_offset)&&(h.end_wrapper<e.end_wrapper))||((h.start_wrapper==e.start_wrapper)&&(h.start_offset==e.start_offset)&&(h.end_wrapper==e.end_wrapper)&&(h.end_offset<e.end_offset))){l.splice(f,0,h.id);p=true;break;}}if(!p){l.push(h.id);}}this.ordered_comment_ids.scope=l;l=[];var k={};for(var g=0,c=this.allComments.length;g<c;g++){var h=this.allComments[g];var m=h.modified;k[h.id]=this._latest_mod(h);}for(var b in k){var d=this.allCommentsByDbId[b].id;var p=false;for(var g=0,c=l.length;g<c;g++){var n=l[g];if(k[b]<k[n]){l.splice(g,0,d);p=true;break;}}if(!p){l.push(d);}}this.ordered_comment_ids.modif_thread=l;},_latest_mod:function(e){var a=e.modified;for(var b=0;b<e.replies.length;b++){var c=e.replies[b];var d=this._latest_mod(c);if(d>a){a=d;}}return a;},_upd:function(a,f,g){var e=false;for(var d=0,b=a.length;d<b;d++){if(a[d].id==g.id){a.splice(d,1,g);e=true;break;}}if(!e){a.push(g);}f[g.id]=g;},upd:function(c){var a=(c.reply_to_id==null)?this.allComments:this.allCommentsByDbId[c.reply_to_id].replies;this._upd(a,this.allCommentsByDbId,c);var b=CY.clone(c);a=(c.reply_to_id==null)?this.comments:this.commentsByDbId[c.reply_to_id].replies;this._upd(a,this.commentsByDbId,b);this._reorder();},initComments:function(a){this.comments=[];for(var d=0,c=this.allComments.length;d<c;d++){var b=CY.Array.indexOf(a,this.allComments[d].id);if(b!=-1){var e=CY.clone(this.allComments[d]);this.comments.push(e);}}this._computeCommentsByDbId();},_computeCommentsByDbId:function(){this.commentsByDbId={};var b=this.getThreads(this.comments);for(var a=0;a<b.length;a++){this.commentsByDbId[b[a].id]=b[a];}},_computeAllCommentsByDbId:function(){this.allCommentsByDbId={};var b=this.getThreads(this.allComments);for(var a=0;a<b.length;a++){this.allCommentsByDbId[b[a].id]=b[a];}},getThreads:function(c){var a=[];for(var b=0;b<c.length;b++){a.push(c[b]);if(c[b].replies.length>0){a=a.concat(this.getThreads(c[b].replies));}}return a;},_getPath:function(b,e){var a=[e];var d=e;while(d.reply_to_id!=null){d=b[d.reply_to_id];a.push(d);}return a;},getPath:function(a){return this._getPath(this.commentsByDbId,a);},getComment:function(a){return this.commentsByDbId[a];},getCommentByIdKey:function(a){for(var c in this.commentsByDbId){var b=this.commentsByDbId[c];if(b.id_key==a){return b;}}return null;},isChild:function(d,a){var c=this.commentsByDbId[d];var b=(d==a);while((!b)&&(c.reply_to_id!=null)){c=this.commentsByDbId[c.reply_to_id];b=(c.id==a);}return b;},initToReadOnly:function(f,a){for(var c=0,b=this.allComments.length;c<b;c++){var e=this.allComments[c];for(var d in e){if(0==d.indexOf("can_")&&typeof e[d]==="boolean"){e[d]=false;}}}},browsingIndex:function(b){var c={};for(var a in this.ordered_comment_ids){var d=CY.Array.filter(this.ordered_comment_ids[a],function(e){return(e in this.commentsByDbId);},this);c[a]=CY.Array.indexOf(d,b);}return c;},browse:function(b,g,d){var a=this.ordered_comment_ids[b];if(a.length>0){var c=-1;if((g=="prev")||(g=="next")){for(var f=0;f<a.length;f++){var h=a[f];if(h==d){c=(g=="prev")?f-1:f+1;c=(a.length+c)%a.length;break;}}if(c==-1){CY.error("internal error in db browse (was called with a dbId that isn't among the filtered ones)");return null;}}if(g=="last"){c=a.length-1;}if(g=="first"){c=0;}for(var f=c,e=0;(f>=0)&&(f<a.length);e++){var h=a[f];if(h in this.commentsByDbId){return this.commentsByDbId[h];}if((g=="prev")||(g=="last")){f=f-1;}else{f=f+1;}f=(a.length+f)%a.length;if(e>a.length){break;}}CY.error("internal error in db browse (could not find any filtered comment)");}return null;},computeFilterResults:function(p){var o={};if(p){for(key in p){if(key.indexOf("filter_")==0){o[key.substr("filter_".length)]=p[key];}}}else{if(gLayout.isInFrame()){o=parent.f_getFrameFilterData();}}var C=[];var y=[];var n="";if("name" in o){n=o.name;}this.filterByName(n,C,y);var F=[];var h=[];var s="";if("date" in o){s=o.date;}this.filterByDate(s,F,h);var j=[];var d=[];var E="";if("text" in o){E=o.text;}this.filterByText(E,j,d);var B=[];var q=[];var x="";if("tag" in o){x=o.tag;}this.filterByTag(x,B,q);var a=[];var f=[];var k="";if("cat" in o){k=o.cat;}this.filterByCat(k,a,f);var w=[];var g=[];var c="";if("state" in o){c=o.state;}this.filterByState(c,w,g);var e=[];var z=[];for(var A=0,m=C.length;A<m;A++){var u=C[A];if((CY.Array.indexOf(F,u)!=-1)&&(CY.Array.indexOf(j,u)!=-1)&&(CY.Array.indexOf(B,u)!=-1)&&(CY.Array.indexOf(a,u)!=-1)&&(CY.Array.indexOf(w,u)!=-1)){e.push(u);}}for(var A=0,m=y.length;A<m;A++){var u=y[A];if((CY.Array.indexOf(h,u)!=-1)&&(CY.Array.indexOf(d,u)!=-1)&&(CY.Array.indexOf(q,u)!=-1)&&(CY.Array.indexOf(f,u)!=-1)&&(CY.Array.indexOf(g,u)!=-1)){z.push(u);}}var t=z.length,b=e.length;var D=b;for(var A=0,m=z.length;A<m;A++){var u=z[A];var r=this.allCommentsByDbId[u];var v=this._getPath(this.allCommentsByDbId,r);var l=v[v.length-1];var u=l.id;if(CY.Array.indexOf(e,u)==-1){e.push(u);D++;}}return{commentIds:e,nbDiscussions:D,nbComments:b,nbReplies:t};},filterByText:function(c,f,a){var b=new RegExp(c,"gi");for(var e in this.allCommentsByDbId){var d=this.allCommentsByDbId[e];if(c==""||b.exec(d.title)!=null||b.exec(d.content)!=null){if(d.reply_to_id==null){f.push(d.id);}else{a.push(d.id);}}}},filterByName:function(a,e,b){for(var d in this.allCommentsByDbId){var c=this.allCommentsByDbId[d];if(a==""||c.name==a){if(c.reply_to_id==null){e.push(c.id);}else{b.push(c.id);}}}},filterByTag:function(i,b,d){var h=new RegExp("^"+i+"$","");var g=new RegExp("^"+i+", ","");var e=new RegExp(", "+i+", ","");var c=new RegExp(", "+i+"$","");for(var a in this.allCommentsByDbId){var f=this.allCommentsByDbId[a];if((i=="")||h.exec(f.tags)!=null||g.exec(f.tags)!=null||e.exec(f.tags)!=null||c.exec(f.tags)!=null){if(f.reply_to_id==null){b.push(f.id);}else{d.push(f.id);}}}},filterByCat:function(a,f,c){for(var e in this.allCommentsByDbId){var d=this.allCommentsByDbId[e];if(a==undefined||a==""||d.category==a){if(d.reply_to_id==null){f.push(d.id);if(d.replies.length){for(var b in d.replies){c.push(d.replies[b].id);}}}}}},filterByState:function(c,a,b){for(var e in this.allCommentsByDbId){var d=this.allCommentsByDbId[e];if(c==""||d.state==c){if(d.reply_to_id==null){a.push(d.id);}else{b.push(d.id);}}}},filterByDate:function(a,d,c){var b=(a=="")?0:parseInt(a);for(var f in this.allCommentsByDbId){var e=this.allCommentsByDbId[f];if(e.modified>b){if(e.reply_to_id==null){d.push(e.id);}else{c.push(e.id);}}}},getCommentsAndRepliesCounts:function(d){var c=0;var f=0;var a=(d)?this.allComments:this.comments;var e=this.getThreads(a);for(var b=0;b<e.length;b++){if(e[b].reply_to_id==null){c++;}else{f++;}}return[c,f];},getCommentsNb:function(b){var a=(b)?this.allComments:this.comments;return this.getThreads(a).length;},getFilteredCommentIdsAsString:function(){var a="";for(var b in this.commentsByDbId){a=a+b+",";}return a;}};hasPerm=function(a){return(-1!=CY.Array.indexOf(sv_user_permissions,a));};gShowingAllComments=false;if(!Array.prototype.indexOf){Array.prototype.indexOf=function(c,d){for(var b=(d||0),a=this.length;b<a;b++){if(this[b]===c){return b;}}return -1;};}Sync=function(){this._q=null;this._iPreventClick=false;};safari_mobile=/iPhone|iPod|iPad/.test(navigator.userAgent);var the_scrolling_part=safari_mobile?"#maincontainer":"document";var add_comment_offset=30;Sync.prototype={init:function(a){this._q=new CY.AsyncQueue();},setPreventClickOn:function(){CY.log("setPreventClickOn !");if(gLayout.isInFrame()){parent.f_interfaceFreeze();}this._iPreventClick=true;},setPreventClickOff:function(){CY.log("setPreventClickOff !");if(gLayout.isInFrame()){parent.f_interfaceUnfreeze();}this._iPreventClick=false;},removeCommentRet:function(b){var f=b.successfull;var a=(f)?b.failure["iComment"]:b.success["iComment"];if(f){var e=b.returned["filterData"];if(gLayout.isInFrame()){parent.f_updateFilterData(e);}var d=gIComments.getTopPosition()[1];var c=gDb.getComment(a.commentId);this._q.add(function(){unpaintCommentScope(c);gIComments.close(c.id);gIComments.remove(c.id);if(c.reply_to_id!=null){gIComments.refresh(c.reply_to_id);}gDb.del(c);if(gLayout.isInFrame()){if(gDb.comments.length==0&&gDb.allComments.length!=0){parent.f_enqueueMsg(gettext("no filtered comments left"));parent.resetFilter();}else{var g=gDb.computeFilterResults();updateFilterResultsCount(g.nbDiscussions,g.nbComments,g.nbReplies);}}});this._animateTo(d);}this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this.resume();},moderateCommentRet:function(d){var f=d.successfull;var a=(f)?d.failure["iComment"]:d.success["iComment"];if(f){var c=d.returned;var e=c.comment;gDb.upd(e);var b=gLayout.isInFrame()&&!parent.f_isFrameFilterFieldsInit();if(b){parent.resetFilter();this._showSingleComment(e);}else{a.changeModeration(e);}}this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this.resume();},saveCommentRet:function(i){var a=i.successfull;if(a){var j=i.success["formId"];var h=i.returned;removeFormErrMsg(j);if("errors" in h){var k=h.errors;for(var d in k){addFormErrMsg(j,d,k[d]);}this._animateToTop();}else{var b=function(){return(gNewReply!=null)&&(j==gNewReply.ids["formId"]);};var e=function(){return(gICommentForm!=null)&&(j==gICommentForm.formId);};var c=function(){return(gEdit!=null)&&(j==gEdit.ids["formId"]);};if(e()){this.hideICommentForm(cleanICommentForm());}else{if(c()){this._hideEditForm();}else{if(b()){this._hideNewReplyForm();}}}if("ask_for_notification" in h){if(h.ask_for_notification){parent.f_yesNoDialog(gettext("Do you want to be notified of all replies in all discussions you participated in?"),gettext("Reply notification"),function(){var m={method:"POST",data:urlEncode({fun:"ownNotify",key:sv_key,version_key:sv_version_key,email:h.email,active:false})};CY.io(sv_client_url,m);},this,null,function(){var m={method:"POST",data:urlEncode({fun:"ownNotify",key:sv_key,version_key:sv_version_key,email:h.email,active:true})};CY.io(sv_client_url,m);},this,null);}}if("comment" in h){var f=h.comment;gDb.upd(f);var g=gLayout.isInFrame()&&parent.f_isFrameFilterFieldsInit();if(g){parent.resetFilter();}else{if(f.reply_to_id==null){unpaintCommentScope(f);paintCommentScope(f);}}var l=h.filterData;if(gLayout.isInFrame()){parent.f_updateFilterData(l);updateResetFilterResultsCount();}if(b()){if(!g){this._insertReply(f);}}else{this._showSingleComment(f);}}else{this._animateToTop();}}}else{this._q.add({id:"expl",fn:function(){CY.log("in example .........");}});this._q.promote("expl");}this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this.resume();},example:function(){CY.log("in example .........");},moderateComment:function(a,b){var c=gDb.getComment(a.commentId);this._q.add({fn:CY.bind(this.setPreventClickOn,this)},{autoContinue:false,fn:CY.bind(doExchange,null,"editComment",{comment_key:c.key,state:b},null,this.moderateCommentRet,this,{iComment:a},gettext("could not save comment"))}).run();},_saveComment:function(b,a){this._q.add({fn:CY.bind(this.setPreventClickOn,this)},{autoContinue:false,fn:CY.bind(doExchange,null,b,{},a,this.saveCommentRet,this,{formId:a},gettext("could not save comment"))}).run();},editComment:function(){this._saveComment("editComment",gEdit.ids["formId"]);},saveComment:function(a){if(readyForAction()){this._saveComment("addComment",a);}},removeComment:function(a){checkForOpenedDialog(a,function(){if(gLayout.isInFrame()){parent.f_yesNoDialog(gettext("Are you sure you want to delete this comment?"),gettext("Warning"),function(){this.animateToTop();},this,null,function(){var b=gDb.getComment(a.commentId);this._q.add({fn:CY.bind(this.setPreventClickOn,this)},{autoContinue:false,fn:CY.bind(doExchange,null,"removeComment",{comment_key:b.key},null,this.removeCommentRet,this,{iComment:a},gettext("could not remove comment"))}).run();},this,null);}},this,null);},resume:function(b,a){this._q.run();},resetAutoContinue:function(a){this._q.getCallback(a).autoContinue=true;},hideICommentForm:function(a){this._q.add({autoContinue:false,fn:CY.bind(gICommentForm.animationHide.run,gICommentForm.animationHide)});if(a){this._q.add(a);}},showCommentForm:function(a){checkForOpenedDialog(null,function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){if(a==null){var b=getSelectionInfo();updateICommentFormSelection(b);}showICommentForm(a);}});this._q.add({autoContinue:false,fn:CY.bind(gICommentForm.animationShow.run,gICommentForm.animationShow)},{fn:CY.bind(this.setPreventClickOff,this)}).run();},this,null);},showEditForm:function(a){checkForOpenedDialog(null,function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){showEditForm(a);}});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},this,null);},showReplyForm:function(a){checkForOpenedDialog(null,function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){instanciateNewReplyForm(a);}});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},this,null);},cancelICommentForm:function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this.hideICommentForm();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},cancelEdit:function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){cancelEditForm();}});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},cancelReply:function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){cancelNewReplyForm();}});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},changeScopeFormClick:function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){changeScopeFormClick();}});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},_hideNewReplyForm:function(){this._q.add({fn:function(){cleanNewReplyForm();cancelNewReplyForm();}});},_hideEditForm:function(){this._q.add({fn:function(){cancelEditForm();}});},_insertReply:function(a){this._q.add({fn:function(){var g=gDb.getComment(a.reply_to_id);var d=gDb.getThreads([g]);var f=d[d.length-2];var c=gIComments.insertAfter(f,a);var h=gIComments.getPosition(a.reply_to_id);c.setPosition(h);var b=gDb.getPath(a);var e=b[b.length-1];if(gIComments.isTopActive(e.id)){c.activate();}c.show();}});this._animateToTop();},_showSingleComment:function(d){if(d!=null){var c=gDb.getPath(d);var b=c[c.length-1];var a=0;if(d.start_wrapper!=-1){a=CY.one(".c-id-"+b.id).getY();}else{a=CY.one(the_scrolling_part).get("scrollTop");}this._showComments([b.id],a,false);if(b.replies.length>0){this._animateTo();}}},_showFocusSingleComment:function(d,c,b){if(d!=null){var a=0;if(d.start_wrapper!=-1){a=CY.one(".c-id-"+d.id).getY();}else{a=CY.one(the_scrolling_part).get("scrollTop");}this._showComments([d.id],a,false);if(d.replies.length>0||b){this._animateToAndFocus(a,c.id,b);}}},showSingleComment:function(a){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._showSingleComment(a);this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},showFocusSingleComment:function(c,b,a){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._showFocusSingleComment(c,b,a);this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},browse:function(a,b){var c=gIComments.browse(a,b);if(c!=null){this.showSingleComment(c);}},_showComments:function(c,b,a){this._q.add({fn:function(){gShowingAllComments=a;gIComments.hide();hideToc();var d=CY.Array.map(c,function(g){return gDb.getComment(g);});var e=gDb.getThreads(d);gIComments.fetch(e);if(c.length>0){if(a){CY.one(the_scrolling_part).set("scrollTop",0);}else{gIComments.activate(c[0]);var f=CY.one(".c-id-"+c[0]);if(f&&!f.inViewportRegion()){f.scrollIntoView(true);if(parent){parent.document.getElementById("outer-north").scrollIntoView(true);}if(safari_mobile){b=add_comment_offset;}else{b+=add_comment_offset;}}}}gIComments.setPosition([gConf.iCommentLeftPadding,b]);gIComments.show();}});},_animateTo:function(a){this._q.add({fn:function(){gIComments.setAnimationToPositions(a);}},{id:"animationRun",autoContinue:false,fn:CY.bind(gIComments.runAnimations,gIComments)});},_animateToAndFocus:function(a,c,b){this._q.add({fn:function(){gIComments.setAnimationToPositionsAndFocus(a,c,b);}},{id:"animationRun",autoContinue:false,fn:CY.bind(gIComments.runAnimations,gIComments)});},_animateToTop:function(){var a=gIComments.getTopPosition();if(a!=null){this._animateTo(a[1]);}},animateToTop:function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},showAllComments:function(){checkForOpenedDialog(null,function(){gShowingAllComments=true;var a=CY.Array.map(gDb.comments,function(b){return b.id;});if(parent.$("#browse_by").val()=="scope"){a.sort(function(d,c){if(gDb.ordered_comment_ids.scope.indexOf(d)<gDb.ordered_comment_ids.scope.indexOf(c)){return -1;}if(gDb.ordered_comment_ids.scope.indexOf(d)>gDb.ordered_comment_ids.scope.indexOf(c)){return 1;}return 0;});}this.showComments(a,[0,add_comment_offset],true);},this,null);},showScopeRemovedComments:function(){checkForOpenedDialog(null,function(){gShowingAllComments=true;var b=CY.Array.filter(gDb.comments,function(c){return(c.start_wrapper==-1);});var a=CY.Array.map(b,function(d){return d.id;});if(parent.$("#browse_by").val()=="scope"){a.sort(function(d,c){if(gDb.ordered_comment_ids.scope.indexOf(d)<gDb.ordered_comment_ids.scope.indexOf(c)){return -1;}if(gDb.ordered_comment_ids.scope.indexOf(d)>gDb.ordered_comment_ids.scope.indexOf(c)){return 1;}return 0;});}this.showComments(a,[0,add_comment_offset],true);},this,null);},showComments:function(c,b,a){checkForOpenedDialog(null,function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._showComments(c,b[1],a);this._animateTo();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},this,null);},openComment:function(a){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});var b=gIComments.getTopPosition()[1];this._q.add({fn:function(){gIComments.open(a.commentId);gIComments.refresh(a.commentId);}});this._animateTo(b);this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},closeComment:function(a){checkForOpenedDialog(a,function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});var b=gIComments.getTopPosition()[1];this._q.add({fn:function(){var c=gDb.getComment(a.commentId);gIComments.close(a.commentId);if(c.reply_to_id!=null){gIComments.refresh(c.reply_to_id);}}});this._animateTo(b);this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},this,null);},activate:function(a){gIComments.activate(a.commentId);}};readyForAction=function(){return !gSync._iPreventClick;};gEditICommentHost=null;gEdit=null;dbgc=null;showEditForm=function(a){if(gEdit==null){gEdit={ids:{formId:CY.guid(),formTitleId:CY.guid(),nameInputId:CY.guid(),emailInputId:CY.guid(),titleInputId:CY.guid(),contentInputId:CY.guid(),tagsInputId:CY.guid(),categoryInputId:CY.guid(),formatInputId:CY.guid(),startWrapperInputId:CY.guid(),endWrapperInputId:CY.guid(),startOffsetInputId:CY.guid(),endOffsetInputId:CY.guid(),changeScopeInputId:CY.guid(),changeScopeInputWrapper:CY.guid(),selectionPlaceId:CY.guid(),keyId:CY.guid(),editCommentId:CY.guid(),currentSelId:CY.guid(),currentSelIdI:CY.guid(),addBtnId:CY.guid(),cancelBtnId:CY.guid()},handlers:{}};}gEditICommentHost=a;gEditICommentHost.hideContent();var c=getHtml(gEdit.ids);var b='<div class="icomment-edit-header">'+c.headerContent+"</div>";var e='<div class="icomment-edit-body">'+c.bodyContent+"</div>";gEditICommentHost.overlay.setStdModContent(CY.WidgetStdMod.HEADER,CY.Node.create(b),CY.WidgetStdMod.AFTER);gEditICommentHost.overlay.setStdModContent(CY.WidgetStdMod.BODY,CY.Node.create(e),CY.WidgetStdMod.AFTER);CY.one("#"+gEdit.ids["formTitleId"]).set("innerHTML",gettext("Edit comment"));var f=gDb.getComment(gEditICommentHost.commentId);CY.one("#"+gEdit.ids["editCommentId"]).set("value",f.id);CY.one("#"+gEdit.ids["keyId"]).set("value",f.key);CY.one("#"+gEdit.ids["changeScopeInputId"]+" input").set("checked",false);if(f.reply_to_id!=null){CY.one("#"+gEdit.ids["changeScopeInputId"]).addClass("displaynone");if(CY.one("#"+gEdit.ids["categoryInputId"])){CY.one("#"+gEdit.ids["categoryInputId"]).addClass("displaynone");CY.one("#"+gEdit.ids["categoryInputId"]).ancestor().addClass("displaynone");}}changeScopeFormClick();CY.one("#"+gEdit.ids["nameInputId"]).set("value",f.name);CY.one("#"+gEdit.ids["emailInputId"]).set("value",f.email);if(f.logged_author){CY.one("#"+gEdit.ids["nameInputId"]).setAttribute("disabled",true);CY.one("#"+gEdit.ids["emailInputId"]).setAttribute("disabled",true);}CY.one("#"+gEdit.ids["titleInputId"]).set("value",f.title);CY.one("#"+gEdit.ids["contentInputId"]).set("value",f.content);CY.one("#"+gEdit.ids["tagsInputId"]).set("value",f.tags);if(CY.one("#"+gEdit.ids["categoryInputId"])){CY.one("#"+gEdit.ids["categoryInputId"]).set("value",f.category);}CY.one("#"+gEdit.ids["formatInputId"]).set("value",gConf.defaultCommentFormat);var d=gLayout.getTopICommentsWidth();changeFormFieldsWidth(gEdit.ids["formId"],d);gEdit.handlers["addBtnId"]=CY.on("click",onEditSaveClick,"#"+gEdit.ids["addBtnId"]);gEdit.handlers["cancelBtnId"]=CY.on("click",onEditCancelClick,"#"+gEdit.ids["cancelBtnId"]);gEdit.handlers["changeScope"]=CY.on("click",onChangeScopeClick,"#"+gEdit.ids["changeScopeInputId"]);};onEditSaveClick=function(a){if(readyForAction()){gSync.editComment();}};onEditCancelClick=function(a){if(readyForAction()){gSync.cancelEdit();}};onChangeScopeClick=function(){if(readyForAction()){gSync.changeScopeFormClick();}else{var a=CY.one("#"+gEdit.ids["changeScopeInputId"]+" input");var b=a.get("checked");a.set("checked",!b);}};changeScopeFormClick=function(){var a=CY.one("#"+gEdit.ids["currentSelId"]);if(CY.one("#"+gEdit.ids["changeScopeInputId"]+" input").get("checked")){a.removeClass("displaynone");}else{a.addClass("displaynone");}};cancelEditForm=function(){if(gEditICommentHost!=null){for(var a in gEdit.handlers){if(gEdit.handlers[a]!=null){gEdit.handlers[a].detach();gEdit.handlers[a]=null;}}gEditICommentHost.overlay.get("contentBox").one(".icomment-edit-body").remove();gEditICommentHost.overlay.get("contentBox").one(".icomment-edit-header").remove();gEditICommentHost.showContent();gEditICommentHost=null;}};IComment=function(){this.commentId=null;var m=gLayout.getTopICommentsWidth();var b=gConf.iCommentLeftPadding;var q=gettext("change comment state to pending");var l=gettext("change comment state to approved");var g=gettext("change comment state to unapproved");var p=gettext("cancel changing the state of this comment");var d=gettext("pending");var e=gettext("approved");var t=gettext("unapproved");var f=gettext("cancel");var o=gettext("show replies");var r=gettext("change to:");var j=ngettext("reply","replies",1);var c=gettext("edit comment");var i=gettext("delete comment");var n=gettext("edit");var h=gettext("delete");var k=gettext("close");var a=gettext("show scope");var s=gettext("Comment is detached: it was created on a previous version and text it applied to has been modified or removed.");this.overlay=new CY.Overlay({zIndex:3,shim:false,visible:false,width:m,xy:[b,0],headerContent:'<div class="icomment-header"><div class="c-iactions"><a class="c-moderate c-action" title="">vis</a> <a class="c-edit c-action" title="'+c+'" alt="'+c+'">'+n+'</a> <a class="c-delete c-action" title="'+i+'" alt="'+i+'">'+h+'</a> </div><div class="c-state-actions displaynone">'+r+'&nbsp;<a class="c-state-pending c-action" title="'+q+'" alt="'+q+'">'+d+'</a> <a class="c-state-approved c-action" title="'+l+'" alt="'+l+'">'+e+'</a> <a class="c-state-unapproved c-action" title="'+g+'" alt="'+g+'">'+t+'</a> <a class="c-state-cancel c-action" title="'+p+'" alt="'+p+'">'+f+'</a> </div><div class="c-no-scope-msg">'+s+'</div><a class="c-show-scope c-action" title="'+a+'" alt="'+a+'"><em>-</em></a><a class="c-close c-action" title="'+k+'" alt="'+k+'"><em>X</em></a></div>',bodyContent:'<div class="icomment-body"><span class="c-content"></span><span class="c-ireplyactions"><a class="c-readreplies c-action" title="'+o+'" alt="'+o+'">'+o+'</a> <a class="c-reply c-action" title="'+j+'" alt="'+j+'">'+j+"</a>&nbsp;</span></div>"});this.overlay.get("contentBox").addClass("c-comment");this.overlay.render("#leftcolumn");this.animation=new CY.Anim({node:this.overlay.get("boundingBox"),duration:gPrefs.get("general","animduration"),easing:CY.Easing.easeOut});this.overlay.get("contentBox").one(".c-close").on("click",this.onCloseCommentClick,this);this.overlay.get("contentBox").one(".c-moderate").on("click",this.onModerateCommentClick,this);this.overlay.get("contentBox").one(".c-state-pending").on("click",this.onPendingCommentClick,this);this.overlay.get("contentBox").one(".c-state-approved").on("click",this.onApprovedCommentClick,this);this.overlay.get("contentBox").one(".c-state-unapproved").on("click",this.onUnapprovedCommentClick,this);this.overlay.get("contentBox").one(".c-state-cancel").on("click",this.onCancelStateChangeClick,this);this.overlay.get("contentBox").one(".c-edit").on("click",this.onEditCommentClick,this);this.overlay.get("contentBox").one(".c-delete").on("click",this.onDeleteCommentClick,this);this.overlay.get("contentBox").one(".c-reply").on("click",this.onReplyCommentClick,this);this.overlay.get("contentBox").one(".c-readreplies").on("click",this.onReadRepliesCommentClick,this);this.overlay.get("contentBox").one(".icomment-header").on("mouseenter",this.onMouseEnterHeader,this);this.overlay.get("contentBox").one(".icomment-header").on("mouseleave",this.onMouseLeaveHeader,this);this.overlay.get("contentBox").on("click",this.onCommentClick,this);};IComment.prototype={onCloseCommentClick:function(a){a.halt();if(readyForAction()&&this.isVisible()){gSync.closeComment(this);}},onModerateCommentClick:function(a){a.halt();if(readyForAction()&&this.isVisible()){this.overlay.get("contentBox").one(".c-iactions").addClass("displaynone");this.overlay.get("contentBox").one(".c-state-actions").removeClass("displaynone");}},onPendingCommentClick:function(a){a.halt();if(readyForAction()&&this.isVisible()){gSync.moderateComment(this,"pending");}},onApprovedCommentClick:function(a){a.halt();if(readyForAction()&&this.isVisible()){gSync.moderateComment(this,"approved");}},onUnapprovedCommentClick:function(a){a.halt();if(readyForAction()&&this.isVisible()){gSync.moderateComment(this,"unapproved");}},onCancelStateChangeClick:function(a){a.halt();if(readyForAction()&&this.isVisible()){this.overlay.get("contentBox").one(".c-iactions").removeClass("displaynone");this.overlay.get("contentBox").one(".c-state-actions").addClass("displaynone");}},onDeleteCommentClick:function(a){a.halt();if(readyForAction()&&this.isVisible()){gSync.removeComment(this);}},onEditCommentClick:function(a){a.halt();if(readyForAction()&&this.isVisible()){gSync.showEditForm(this);}},onReplyCommentClick:function(a){a.halt();if(readyForAction()&&this.isVisible()){gSync.showReplyForm(this);}},onReadRepliesCommentClick:function(a){a.halt();if(readyForAction()&&this.isVisible()){gSync.openComment(this);}},onCommentClick:function(f){if(readyForAction()&&this.isVisible()){if(f.target.get("target")=="_blank"){var c=f.target;var d=sv_site_url+sv_text_view_show_comment_url;if(c.get("href").indexOf(d)==0){var b=(new RegExp("comment_id_key=([^&]*)","g")).exec(c.get("href"));if(b!=null){var a=b[1];var g=gDb.getCommentByIdKey(a);if(g!=null){f.halt();if(!c.hasClass("c-permalink")){checkForOpenedDialog(null,function(){gSync.showSingleComment(g);});}}}}}else{if(gShowingAllComments){if(!this._isHostingAForm()){var g=gDb.getComment(this.commentId);checkForOpenedDialog(null,function(){if(g!=null){gSync.showSingleComment(g);}});}}else{gSync.activate(this);}}}},onMouseEnterHeader:function(){if(readyForAction()&&this.isVisible()){this.overlay.get("contentBox").one(".c-permalink").removeClass("displaynone");}},onMouseLeaveHeader:function(){if(readyForAction()&&this.isVisible()){this.overlay.get("contentBox").one(".c-permalink").addClass("displaynone");}},setWidth:function(a){this.overlay.get("boundingBox").setStyle("width",a+"px");},activate:function(){this.overlay.get("boundingBox").addClass("c-focus-comment");},deactivate:function(){this.overlay.get("boundingBox").removeClass("c-focus-comment");},hide:function(){if(gIComments.isTopActive(this.commentId)){if(!gIComments.activateVisibleNext()){gIComments.deactivate();}}if(this.isVisible()){this.overlay.hide();this.overlay.blur();}},hideContent:function(){this.overlay.get("contentBox").one(".icomment-header").addClass("displaynone");this.overlay.get("contentBox").one(".icomment-body").addClass("displaynone");},showContent:function(){this.overlay.get("contentBox").one(".icomment-header").removeClass("displaynone");this.overlay.get("contentBox").one(".icomment-body").removeClass("displaynone");},isVisible:function(){return this.overlay.get("visible");},show:function(){this.hideReadRepliesLnk();return this.overlay.show();},showReadRepliesLnk:function(){this.overlay.get("contentBox").one(".c-readreplies").removeClass("displaynone");},hideReadRepliesLnk:function(){this.overlay.get("contentBox").one(".c-readreplies").addClass("displaynone");},changeModeration:function(b){var a=this.overlay.get("contentBox").one(".c-moderate");a.set("innerHTML",gettext(b.state));a.removeClass("c-state-approved");a.removeClass("c-state-pending");a.removeClass("c-state-unapproved");a.addClass("c-state-"+b.state);this.overlay.get("contentBox").one(".c-iactions").removeClass("displaynone");this.overlay.get("contentBox").one(".c-state-actions").addClass("displaynone");},isfetched:function(){return(this.commentId!=null);},unfetch:function(){this.commentId=null;},fetch:function(k){this.commentId=k.id;var j=this.overlay.get("boundingBox");if(k.start_wrapper!=-1){j.addClass("c-has-scope");j.removeClass("c-has-no-scope");}else{j.addClass("c-has-no-scope");j.removeClass("c-has-scope");}if(k.reply_to_id!=null){j.addClass("c-is-reply");}else{j.removeClass("c-is-reply");}var f=interpolate(gettext("last modified on %(date)s"),{date:k.modified_user_str},true);var n=(k.modified==k.created)?"":'<a title="'+f+'"> * </a>';var a=gettext("Permalink to this comment");var p='<a class="c-permalink displaynone c-action" target="_blank" title="'+a+'" href="" >¶&nbsp;</a>';var l=interpolate(gettext("by %(name)s, created on %(date)s"),{name:k.name,date:k.created_user_str},true);var e='<span class="c-header"><div class="c-header-title">'+k.title+p+'</div><div class="c-infos">'+l+"</div></span>";var h=CY.Node.create(e);var q=j.one(".c-header");if(q==null){j.one(".icomment-header").insertBefore(h,j.one(".c-iactions"));}else{q.get("parentNode").replaceChild(h,q);}var d=CY.Node.create('<div class="c-tags"><span class="c-tags-infos">tags:</span>'+k.tags+"</div>");var o=j.one(".c-tags");if(o==null){j.one(".icomment-header").appendChild(d);}else{o.get("parentNode").replaceChild(d,o);}if(k.tags==""){d.addClass("displaynone");}var c=CY.Node.create('<div class="c-cat">'+gettext("category")+':&nbsp;<span class="c-cat-val c-cat-'+k.category+'">'+categories[k.category]+"</span></div>");var b=j.one(".c-cat");if(b==null){j.one(".icomment-header").appendChild(c);}else{b.get("parentNode").replaceChild(c,b);}if(k.category==0){c.addClass("displaynone");}var g=CY.Node.create('<span class="c-content">'+k.content_html+"</span>");var i=j.one(".c-content");if(i==null){j.one(".icomment-body").appendChild(g);}else{i.get("parentNode").replaceChild(g,i);}if(sv_prefix==""){j.one(".c-permalink").set("href",sv_site_url+k.permalink);}else{comment_id_delta_prefix=sv_delta!=""?Array(parseInt(sv_delta)+1).join(","):"";j.one(".c-permalink").set("href",top.location.protocol+"//"+top.location.hostname+top.location.pathname+"?comment_id_key="+comment_id_delta_prefix+k.id_key);}this.changeModeration(k);var m=j.all(".c-content a");if(m!=null){m.setAttribute("target","_blank");}m=j.all(".c-header-title a");if(m!=null){m.setAttribute("target","_blank");}this.permAdapt(k);},permAdapt:function(e){var d=this.overlay.get("contentBox").one(".c-delete");if(d){if(!e.can_delete){d.addClass("displaynone");}else{d.removeClass("displaynone");}}var c=this.overlay.get("contentBox").one(".c-edit");if(c){if(!e.can_edit){c.addClass("displaynone");}else{c.removeClass("displaynone");}}var a=this.overlay.get("contentBox").one(".c-reply");if(a){if(!hasPerm("can_create_comment")){a.addClass("displaynone");}else{a.removeClass("displaynone");}}var b=this.overlay.get("contentBox").one(".c-moderate");if(b){if(!e.can_moderate){b.addClass("displaynone");}else{b.removeClass("displaynone");}}},setThreadPad:function(a){this.overlay.get("contentBox").one(".yui-widget-hd").setStyle("paddingLeft",a+"px");this.overlay.get("contentBox").one(".yui-widget-bd").setStyle("paddingLeft",a+"px");},setPosition:function(b){var a=this.overlay.get("boundingBox");a.setStyle("opacity",1);a.setXY(b);},getPosition:function(b){var a=this.overlay.get("boundingBox");return a.getXY();},onAnimationEnd:function(){if(!CY.Lang.isUndefined(this["animation-handle"])&&!CY.Lang.isNull(this["animation-handle"])){this["animation-handle"].detach();this["animation-handle"]=null;}gIComments.signalAnimationEnd();if(gIComments.animationsEnded()){gIComments.whenAnimationsEnd();}},onAnimationEndFocus:function(){if(!CY.Lang.isUndefined(this["animation-handle"])&&!CY.Lang.isNull(this["animation-handle"])){this["animation-handle"].detach();this["animation-handle"]=null;}gIComments.signalAnimationEnd();if(gIComments.animationsEnded()){gIComments.whenAnimationsEndFocus();}},onAnimationEndReply:function(){if(!CY.Lang.isUndefined(this["animation-handle"])&&!CY.Lang.isNull(this["animation-handle"])){this["animation-handle"].detach();this["animation-handle"]=null;}gIComments.signalAnimationEnd();if(gIComments.animationsEnded()){gIComments.whenAnimationsEndReply();}},setAnimationToPosition:function(d,a,c){var b=this.overlay.get("boundingBox");if(gPrefs.get("general","animduration")<0.011){b.setXY(d);}this.animation.set("to",{xy:d});this.animation.set("duration",gPrefs.get("general","animduration"));if(a){if(c){this["animation-handle"]=this.animation.on("end",this.onAnimationEndReply,this);}else{this["animation-handle"]=this.animation.on("end",this.onAnimationEndFocus,this);}}else{this["animation-handle"]=this.animation.on("end",this.onAnimationEnd,this);}return this.animation;},getHeight:function(){return this.overlay.get("boundingBox").get("offsetHeight");},scrollIntoView:function(){if(!this.overlay.get("contentBox").inViewportRegion()){this.overlay.get("contentBox").scrollIntoView(true);}},_isHostingAForm:function(){return(this.isVisible()&&((gNewReplyHost!=null&&gNewReplyHost==this)||(gEditICommentHost!=null&&gEditICommentHost==this)));}};gToc=null;instanciateToc=function(){gToc={tocId:CY.guid(),tocTitleId:CY.guid(),closeBtnId:CY.guid(),empty:false};var g={};g.headerContent='<div id="'+gToc.tocId+'"><h3 id="'+gToc.tocTitleId+'"></h3>';var a=getElementsByTagNames("h2,h3,h4,h5,h6",document.getElementById("maincontainer"));var h=document.createElement("div");if(a.length>=2){for(var f=0;f<a.length;f++){var e=document.createElement("a");e.innerHTML=a[f].innerHTML.replace(/<\/?a[^>]*>/ig,"");e.className="page indent"+a[f].nodeName;h.appendChild(e);var j=a[f].id||"link"+f;e.href="#"+j;a[f].id=j;}}else{h.innerHTML="";gToc.empty=true;}g.bodyContent=h.innerHTML;var b=gLayout.getTopICommentsWidth();b+=gLayout.iCommentsRequiredThreadPadding();var d=new CY.Overlay({zIndex:3,shim:false,visible:false,headerContent:g.headerContent,bodyContent:g.bodyContent,xy:[3,30],width:b});d.get("contentBox").addClass("c-toc");d.get("contentBox").set("id","the-toc");d.render("#leftcolumn");CY.one("#"+gToc.tocTitleId).set("innerHTML",gettext("Table of contents"));gToc.overlay=d;var k=null;k=new CY.Anim({node:d.get("boundingBox"),duration:0.3,easing:CY.Easing.easeOut});gToc.animationHide=k;k.set("to",{opacity:0});gToc["animationHide-handle"]=k.on("end",onTocHideAnimEnd,gToc);var c=null;c=new CY.Anim({node:d.get("boundingBox"),duration:0.3,easing:CY.Easing.easeOut});gToc.animationShow=c;c.set("to",{opacity:1});gToc["animationShow-handle"]=c.on("end",onTocShowAnimEnd,gToc);getElementsByClassName("c-toc")[0].style.width=b+"px";};toggleTocFn=function(){if(isTocVisible()){hideToc();}else{showToc();}};hideToc=function(){gToc.overlay.hide();};onTocHideAnimEnd=function(){this.overlay.hide();gSync.resume();};onTocShowAnimEnd=function(){gSync.resume();};showToc=function(){removeFormErrMsg(gToc.tocId);gIComments.hide();gToc.overlay.show();};isTocVisible=function(){if(gToc!=null){return gToc.overlay.get("visible");}return false;};function getElementsByTagNames(g,h){if(!h){var h=document;}var f=g.split(",");var a=new Array();for(var e=0;e<f.length;e++){var c=h.getElementsByTagName(f[e]);for(var b=0;b<c.length;b++){a.push(c[b]);}}var d=a[0];if(!d){return[];}if(d.sourceIndex){a.sort(function(j,i){return j.sourceIndex-i.sourceIndex;});}else{if(d.compareDocumentPosition){a.sort(function(j,i){return 3-(j.compareDocumentPosition(i)&6);});}}return a;}var getElementsByClassName=function(b,a,c){if(document.getElementsByClassName){getElementsByClassName=function(d,m,h){h=h||document;var j=h.getElementsByClassName(d),l=(m)?new RegExp("\\b"+m+"\\b","i"):null,e=[],g;for(var f=0,k=j.length;f<k;f+=1){g=j[f];if(!l||l.test(g.nodeName)){e.push(g);}}return e;};}else{if(document.evaluate){getElementsByClassName=function(d,r,n){r=r||"*";n=n||document;var g=d.split(" "),q="",l="http://www.w3.org/1999/xhtml",p=(document.documentElement.namespaceURI===l)?l:null,i=[],o,f;for(var h=0,k=g.length;h<k;h+=1){q+="[contains(concat(' ', @class, ' '), ' "+g[h]+" ')]";}try{o=document.evaluate(".//"+r+q,n,p,0,null);}catch(m){o=document.evaluate(".//"+r+q,n,null,0,null);}while((f=o.iterateNext())){i.push(f);}return i;};}else{getElementsByClassName=function(e,u,q){u=u||"*";q=q||document;var h=e.split(" "),t=[],r=(u==="*"&&q.all)?q.all:q.getElementsByTagName(u),p,n=[],o;for(var i=0,d=h.length;i<d;i+=1){t.push(new RegExp("(^|\\s)"+h[i]+"(\\s|$)"));}for(var g=0,s=r.length;g<s;g+=1){p=r[g];o=false;for(var f=0,j=t.length;f<j;f+=1){o=t[f].test(p.className);if(!o){break;}}if(o){n.push(p);}}return n;};}}return getElementsByClassName(b,a,c);};var gtest={renaud:"RENAUD",random:Math.random(),bernard:"BERNARD",myFunc:function(){doExchange("theServerFun",{},null,this.myRetFunc,this,["foo","bar"]);},myRetFunc:function(a){CY.log("this.renaud : "+this.renaud);CY.log("this.random : "+this.random);CY.log("arg.returned : "+a.returned);CY.log(a.returned);CY.log("arg.success : "+a.success);CY.log(a.success);}};doExchange=function(h,e,g,f,d,c,b){e.fun=h;e.key=sv_key;e.version_key=sv_version_key;var a={method:"POST",data:urlEncode(e),on:{success:function(l,k,j){var i={};if(k.responseText){i=CY.JSON.parse(k.responseText);}if(gLayout.isInFrame()&&("msg" in i)){parent.f_enqueueMsg(i.msg);}j.returned=i;j.successfull=true;f.call(d,j);},failure:function(k,j,i){if(gLayout.isInFrame()){parent.f_enqueueErrorMsg(gettext("error:")+b);}i.successfull=false;f.call(d,i);}},arguments:{success:c,failure:c}};if(g!=null){a.form={id:g};}CY.io(sv_client_url,a);};warn_server=function(c){c.fun="warn";c.key=sv_key;c.version_key=sv_version_key;var b=CY.UA;var a={method:"POST",data:urlEncode(CY.merge(c,b))};CY.io("/client/",a);};Layout=function(){};Layout.prototype={init:function(){},isInFrame:function(){return(!CY.Lang.isUndefined(parent)&&parent.location!=location&&CY.Lang.isFunction(parent.f_getFrameFilterData));},isInComentSite:function(){var d=false;try{if(!CY.Lang.isUndefined(sv_site_url)&&!CY.Lang.isUndefined(parent)&&!CY.Lang.isUndefined(parent.parent)){var e=new String(parent.parent.location);d=(e.indexOf(sv_site_url)==0);}}catch(f){d=false;}return d;},sliderValToPx:function(g){var h=CY.DOM.winWidth();if(this.isInFrame()){h=parent.$(parent).width();}var e=g/100;e=Math.min(e,gConf.sliderFixedMin);e=Math.max(e,gConf.sliderFixedMax);var f=e*h;return Math.floor(f);},getTopICommentsWidth:function(){return this.getTopICommentsWidthFromWidth(this.sliderValToPx(gPrefs.get("layout","comments_col_width")));},iCommentsRequiredThreadPadding:function(){return 2*gConf.iCommentThreadPadding;},getTopICommentsWidthFromWidth:function(d){var e=d-this.iCommentsRequiredThreadPadding();return e-7;},setLeftColumnWidth:function(b){CY.one("#contentcolumn").setStyle("marginLeft",b+"px");CY.one("#leftcolumn").setStyle("width",b+"px");},parentInterfaceUnfreeze:function(){if(this.isInFrame()){parent.f_interfaceUnfreeze();}}};gNoSelectionYet=gettext("No selection yet");gFormHtml={formStart:'<form id="###" onsubmit="return false;">',nameInput:gettext("Username:")+'<center><input id="###" name="name" class="n_name user_input" style="padding:1px;" type="text"></input></center>',emailInput:gettext("E-mail address:")+'<center><input id="###" name="email" class="n_email user_input" style="padding:1px;" type="text"></input></center>',titleInput:gettext("Title:")+'<center><input id="###" name="title" class="n_title comment_input" style="padding:1px;" type="text"></input></center>',contentInput:gettext("Content:")+'<center><textarea id="###" name="content" class="n_content comment_input" rows="10" style="padding:1px;"></textarea></center>',tagsInput:gettext("Tag:")+'<center><input id="###" name="tags" class="n_tags comment_input" style="padding:1px;" type="text"></input></center>',hidden:'<input id="###" class="comment_input" name="???" type="hidden" value=""></input>',formEnd:"</form>",changeScope:'<div id="###">'+gettext("Modify comment's scope:")+'<input type="checkbox" name="change_scope"></input></div>',headerTitle:'<center><div id="###" class="c-header-title"></div></center>',currentSel:'<div id="###">'+gettext("Comment will apply to this selection:")+'<br/><div class="current_sel"><div id="???" class="current_sel_ins">'+gNoSelectionYet+"</div></div>#hiddeninput#</div>",btns:'<center><input id="###" type="button" value="'+gettext("Save")+'" /><input id="???" type="button" value="'+gettext("Cancel")+'" /></center>',closeIcon:'<a id="###" class="c-close" title="'+gettext("close")+'"><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</em></a>'};getHtml=function(l){ret={};ret.headerContent="";if("closeBtnId" in l){ret.headerContent+=gFormHtml.closeIcon.replace("###",l.closeBtnId);}ret.headerContent+=gFormHtml.headerTitle.replace("###",l.formTitleId);var j="";if("changeScopeInputId" in l){j=gFormHtml.changeScope.replace("###",l.changeScopeInputId);}var i="<center>"+gFormHtml.hidden.replace("###",l.selectionPlaceId).replace("???","selection_place")+"</center>";var k=gFormHtml.currentSel.replace("###",l.currentSelId).replace("???",l.currentSelIdI).replace("#hiddeninput#",i);var m=gFormHtml.btns.replace("###",l.addBtnId).replace("???",l.cancelBtnId);var h=gFormHtml.formStart.replace("###",l.formId)+j+k;if("nameInputId" in l){h=h+gFormHtml.nameInput.replace("###",l.nameInputId);}if("emailInputId" in l){h=h+gFormHtml.emailInput.replace("###",l.emailInputId);}h=h+gFormHtml.titleInput.replace("###",l.titleInputId)+gFormHtml.contentInput.replace("###",l.contentInputId);categories=CY.JSON.parse(sv_categories);if(categories.hasOwnProperty("0")){category_options="";for(c in categories){category_options+='<option value="'+c+'">'+categories[c]+"</option>";}gFormHtml.categoryInput=gettext("Category:")+'&nbsp;<select id="###" name="category" class="n_category comment_input" style="padding:1px;" type="text">'+category_options+"</select>";h=h+'<span class="n_category_input">'+gFormHtml.categoryInput.replace("###",l.categoryInputId)+"<br /></span>";}h=h+gFormHtml.tagsInput.replace("###",l.tagsInputId);h=h+gFormHtml.hidden.replace("###",l.formatInputId).replace("???","format");h=h+gFormHtml.hidden.replace("###",l.startWrapperInputId).replace("???","start_wrapper");h=h+gFormHtml.hidden.replace("###",l.endWrapperInputId).replace("???","end_wrapper");h=h+gFormHtml.hidden.replace("###",l.startOffsetInputId).replace("???","start_offset");h=h+gFormHtml.hidden.replace("###",l.endOffsetInputId).replace("???","end_offset");h=h+gFormHtml.hidden.replace("###",l.keyId).replace("???","comment_key");h=h+gFormHtml.hidden.replace("###",l.editCommentId).replace("???","edit_comment_id");h=h+m+gFormHtml.formEnd;ret.bodyContent=h;return ret;};changeFormFieldsWidth=function(h,i){var g=(i-20)+"px";var f=CY.all("#"+h+" input[type='text']");if(f!=null){f.setStyle("width",g);}f=CY.all("#"+h+" textarea");if(f!=null){f.setStyle("width",g);}};addFormErrMsg=function(l,e,q){var i=document.getElementById(l);var o,m,n,p;for(o=0,p=i.elements.length;o<p;++o){m=i.elements[o];if(m.name==e){n=document.createElement("DIV");CY.DOM.addClass(n,"c-error");n.id=m.id+"-err";n.appendChild(document.createTextNode(q));if(m.parentNode.nextSibling){m.parentNode.parentNode.insertBefore(n,m.parentNode.nextSibling);}else{m.parentNode.parentNode.appendChild(n);}}}};removeFormErrMsg=function(d){var e=CY.all("#"+d+" .c-error");if(e!=null){e.each(function(a){a.remove();});}};getWrapperAncestor=function(d){var e=d;while(e!=null){if(CY.DOM.hasClass(e,"c-s")){return e;}e=e.parentNode;}return null;};hasWrapperAncestor=function(b){return(getWrapperAncestor(b)!=null);};getSelectionInfo=function(){var Y=null,j=null,T=0,aj=0,af="";if(window.getSelection){var Q=safari_mobile?storedSelection:window.getSelection();if(Q.rangeCount>0){var ad=Q.getRangeAt(0);af=ad.toString();if(af!=""){var V=document.createRange();V.setStart(Q.anchorNode,Q.anchorOffset);V.collapse(true);var Z=document.createRange();Z.setEnd(Q.focusNode,Q.focusOffset);Z.collapse(false);var K=(Z.compareBoundaryPoints(2,V)==1);Y=(K)?Q.anchorNode.parentNode:Q.focusNode.parentNode;if(Y.nodeName=="mi"||Y.nodeName=="mo"){Y=Y.parentElement.parentElement.parentElement.parentElement;}innerStartNode=(K)?Q.anchorNode:Q.focusNode;j=(K)?Q.focusNode.parentNode:Q.anchorNode.parentNode;if(j.nodeName=="mi"||j.nodeName=="mo"){j=j.parentElement.parentElement.parentElement.parentElement;}innerEndNode=(K)?Q.focusNode:Q.anchorNode;T=(K)?Q.anchorOffset:Q.focusOffset;aj=(K)?Q.focusOffset:Q.anchorOffset;if(!hasWrapperAncestor(j)&&hasWrapperAncestor(Y)){var i=document.createRange();i.setStart(innerStartNode,T);var ak=getWrapperAncestor(Y);var U=ak;i.setEndAfter(U);var ah=parseInt(ak.id.substring("sv_".length));while(i.toString().length<ad.toString().length){ah++;var S=CY.one("#sv_"+ah);if(S){U=CY.Node.getDOMNode(S);i.setEndAfter(U);}else{break;}}j=U.lastChild;aj=CY.DOM.getText(j).length;}else{if(!hasWrapperAncestor(Y)&&hasWrapperAncestor(j)){var i=document.createRange();i.setEnd(innerEndNode,aj);var ag=getWrapperAncestor(j);var aa=ag;i.setStartBefore(aa);var ah=parseInt(ag.id.substring("sv_".length));while(i.toString().length<ad.toString().length){ah--;var S=CY.one("#sv_"+ah);if(S){aa=CY.Node.getDOMNode(S);i.setStartBefore(aa);}else{break;}}Y=aa.firstChild;T=0;}else{if(!hasWrapperAncestor(Y)&&!hasWrapperAncestor(j)){var ab=af.length;var ac=[];for(var ah=0;;ah++){var s=CY.one("#sv_"+ah);if(s==null){break;}else{var M=s.get("text");if(af.indexOf(M)==0){ac.push(ah);}}}var R=[];for(var ah=0;;ah++){var s=CY.one("#sv_"+ah);if(s==null){break;}else{var M=s.get("text");if(af.indexOf(M)==(ab-M.length)){R.push(ah);}}}var L=false;for(var X=0;X<ac.length;X++){for(var e=0;e<R.length;e++){var O=document.createRange();var ae=CY.Node.getDOMNode(CY.one("#sv_"+ac[X]));var N=CY.Node.getDOMNode(CY.one("#sv_"+R[e]));O.setStartBefore(ae);O.setEndAfter(CY.Node.getDOMNode(N));if((-1<O.compareBoundaryPoints(0,ad))&&(1>O.compareBoundaryPoints(2,ad))){Y=ae.firstChild;T=0;j=N.lastChild;aj=CY.DOM.getText(N).length;L=true;break;}}if(L){break;}}}}}V.detach();Z.detach();}else{return null;}}else{return null;}}else{if(document.selection){var ai=document.selection.createRange();if(ai.text.length==0){return null;}var al=ai.parentElement();var W=ai.duplicate();var P=ai.duplicate();W.collapse(true);P.collapse(false);Y=W.parentElement();while(W.moveStart("character",-1)!=0){if(W.parentElement()!=Y){break;}T++;}j=P.parentElement();while(P.moveEnd("character",-1)!=0){if(P.parentElement()!=j){break;}aj++;}af=ai.text;}}if(!hasWrapperAncestor(Y)||!hasWrapperAncestor(j)){return null;}return{text:af,start:{elt:Y,offset:T},end:{elt:j,offset:aj}};};_afterDlg=function(f){var g=f[0];var e=f[1];var h=f[2];g.call(e,h);};_abortNewCommentConfirmed=function(b){if(isICommentFormVisible()){if(gLayout.isInFrame()){gSync.hideICommentForm({fn:function(){_afterDlg(b);}});gSync.resume();}}};_abortNewReplyConfirmed=function(b){if(gNewReplyHost!=null){if(gLayout.isInFrame()){cancelNewReplyForm();_afterDlg(b);}}};_abortNewEditConfirmed=function(b){if(gEditICommentHost!=null){if(gLayout.isInFrame()){cancelEditForm();_afterDlg(b);}}};checkForOpenedDialog=function(j,h,g,f){var i=[];if(j!=null){i=CY.Array.map(gDb.getThreads([gDb.getComment(j.commentId)]),function(a){return a.id;});}if(isICommentFormVisible()||(gNewReplyHost!=null&&(j==null||CY.Array.indexOf(i,gNewReplyHost.commentId)!=-1))||(gEditICommentHost!=null&&(j==null||CY.Array.indexOf(i,gEditICommentHost.commentId)!=-1))){if(gLayout.isInFrame()){if(isICommentFormVisible()){parent.f_yesNoDialog(gettext("New comment will be canceled, continue?"),gettext("Warning"),null,null,null,_abortNewCommentConfirmed,this,[h,g,f]);}else{if(gNewReplyHost!=null){parent.f_yesNoDialog(gettext("Started reply will be canceled, continue?"),gettext("Warning"),null,null,null,_abortNewReplyConfirmed,this,[h,g,f]);}else{if(gEditICommentHost!=null){parent.f_yesNoDialog(gettext("Started comment edition will be canceled, continue?"),gettext("Warning"),null,null,null,_abortNewEditConfirmed,this,[h,g,f]);}}}}}else{h.call(g,[]);}};paintCommentScope=function(d){if(d.reply_to_id==null&&d.start_wrapper!=-1){var e={start:{elt:document.getElementById("sv_"+d.start_wrapper),offset:d.start_offset},end:{elt:document.getElementById("sv_"+d.end_wrapper),offset:d.end_offset}};if(document.getElementById("sv_"+d.start_wrapper)==null){warn_server({from:"paintCommentScope",start_wrapper:d.start_wrapper});}else{if(document.getElementById("sv_"+d.end_wrapper)==null){warn_server({from:"paintCommentScope",end_wrapper:d.end_wrapper});}else{e.start=_convertSelectionFromCSToCC(e.start);e.end=_convertSelectionFromCSToCC(e.end);renderComment(e,d.id);}}}};getCommentIdsFromClasses=function(f){var g=[];var h=f.className.split(" ");for(var i=0,j=h.length;i<j;i++){if(h[i].indexOf("c-id-")==0){g.push(parseInt(h[i].substring("c-id-".length)));}}return g;};renderComment=function(g,k){var i=g.start.offset;var l=g.end.offset;var j=g.start.elt;var h=g.end.elt;if((j!=null)&&(h!=null)&&_getTextNodeContent(j)!=""&&_getTextNodeContent(h)!=""){markWholeNodesAsComments(j,h,k);markEndsAsComments(j,i,h,l,k);}};markWholeNodesAsComments=function(g,f,e){var h=_findCommonAncestor(g,f);_dynSpanToAnc(g,h,e,false);_dynSpanToAnc(f,h,e,true);_dynSpanInBetween(h,g,f,e);};_setTextNodeContent=function(e,d){CY.DOM.setText(e,d);};_getTextNodeContent=function(b){return CY.DOM.getText(b);};markEndsAsComments=function(C,F,q,w,D){var s=_getTextNodeContent(C).substring(0,F);var u=_getTextNodeContent(C).substring(F);var t=_getTextNodeContent(q).substring(0,w);var z=_getTextNodeContent(q).substring(w);var E=(C===q);if(u!=""){if(CY.DOM.hasClass(C,"c-c")){var A=null,r=null,y=null,x=null;var v=(E)?_getTextNodeContent(C).substring(F,w):u;if(E&&(z!="")){y=C;A=y;}if(v!=""){if(A==null){r=C;}else{r=_yuiCloneNode(C);A.parentNode.insertBefore(r,A);}A=r;}if(s!=""){if(A==null){x=C;}else{x=_yuiCloneNode(C);A.parentNode.insertBefore(x,A);}A=x;}if(y!=null){_setTextNodeContent(y,z);}if(r!=null){_setTextNodeContent(r,v);_addIdClass(r,D);}if(x!=null){_setTextNodeContent(x,s);}}}if((!E)&&(t!="")){if(CY.DOM.hasClass(q,"c-c")){var A=null,B=null,y=null;if(z!=""){y=q;A=q;}if(t!=""){if(A==null){B=q;}else{B=_yuiCloneNode(q);A.parentNode.insertBefore(B,A);}A=B;}if(y!=null){_setTextNodeContent(y,z);}if(B!=null){_addIdClass(B,D);_setTextNodeContent(B,t);}}}};_yuiCloneNode=function(d){var e=CY.Node.getDOMNode(CY.one("#"+d.id).cloneNode(true));e.id=CY.guid();return e;};_dynSpanToAnc=function(m,h,i,k){var j=m;while((j!=null)&&(j!==h)&&(j.parentNode!==h)){var l=null;if(k){l=j.previousSibling;}else{l=j.nextSibling;}if(l==null){j=j.parentNode;}else{j=l;_recAddComment(j,i);}}};_dynSpanInBetween=function(j,i,k,m){var n=i;var a=null;while(n){if(n.parentNode===j){a=n;break;}n=n.parentNode;}if(a!=null){n=k;var l=null;while(n){if(n.parentNode===j){l=n;break;}n=n.parentNode;}if(l!=null){n=a.nextSibling;while((n!=null)&&(n!==l)){_recAddComment(n,m);n=n.nextSibling;}}}};_bruteContains=function(e,d){while(d){if(e===d){return true;}d=d.parentNode;}return false;};_addIdClass=function(d,e){CY.DOM.addClass(d,"c-id-"+e);var f=_findParentBlockElt(d);if(f!=null){_unpaintCategories(f);_repaintCategories(d,f);}_updateCommentCounter(d);};_removeIdClass=function(d,e){CY.DOM.removeClass(d,"c-id-"+e);var f=_findParentBlockElt(d);if(f!=null){_unpaintCategories(f);_repaintCategories(d,f,e);}_updateCommentCounter(d);};_removeIdClasses=function(e){var d=_cgetRegExp("(?:^|\\s+)c-id-(?:\\d+)","g");e.className=e.className.replace(d," ");_updateCommentCounter(e);var f=_findParentBlockElt(e);if(f!=null){_unpaintCategories(f);}};_findParentBlockElt=function(h){var g=h;var f=g.currentStyle||window.getComputedStyle(g,"");var e=f.display;while(g!=null&&e!="block"){g=g.parentElement;f=g.currentStyle||window.getComputedStyle(g,"");e=f.display;}return g;};_unpaintCategories=function(b){CY.DOM.removeClass(b,"cat1");CY.DOM.removeClass(b,"cat2");CY.DOM.removeClass(b,"cat3");CY.DOM.removeClass(b,"cat4");CY.DOM.removeClass(b,"cat5");};_repaintCategories=function(m,k,n){var h=parseInt(getWrapperAncestor(m).id.substr(3));var i=gDb.comments.length;for(var l=0;l<i;l++){if(l in gDb.comments){var j=gDb.comments[l];if((n==null||j.id!=n)&&j.start_wrapper<=h&&j.end_wrapper>=h){if(j.category){CY.DOM.addClass(k,"cat"+j.category);}}}}};_recAddComment=function(e,f){if(CY.DOM.hasClass(e,"c-c")){_addIdClass(e,f);}else{var g=e.firstChild;while(g!=null){_recAddComment(g,f);g=g.nextSibling;}}};_findCommonAncestor=function(f,e){if(_bruteContains(f,e)){return f;}else{var d=e;while((d!=null)&&!_bruteContains(d,f)){d=d.parentNode;}return d;}};_cregexCache={};_cgetRegExp=function(d,e){e=e||"";if(!_cregexCache[d+e]){_cregexCache[d+e]=new RegExp(d,e);}return _cregexCache[d+e];};_updateCommentCounter=function(f){var e=_cgetRegExp("(?:^|\\s+)c-id-(?:\\d+)","g");var g=f.className.match(e);var h=(g==null)?0:gDb.getThreads(CY.Array.map(g,function(a){return gDb.getComment(parseInt(a.replace(/\D/g,"")));})).length;e=_cgetRegExp("(?:^|\\s+)c-count-(?:\\d+)","g");f.className=f.className.replace(e," ");CY.DOM.addClass(f,"c-count-"+h+" ");if(h>0){f.setAttribute("title",h+ngettext(" comment"," comments",h));if(h>25){CY.DOM.addClass(f,"c-count-25");}}};_convertSelectionFromCCToCS=function(e){var g=e.offset;var f=e.elt.parentNode;var h=e.elt.previousSibling;while(h!=null){g+=_getTextNodeContent(h).length;h=h.previousSibling;}return{elt:f,offset:g};};_convertSelectionFromCSToCC=function(k){var l={elt:null,offset:-1};var i=null;var j=k.elt.firstChild;var h=0;while(j!=null){var g=h;h+=_getTextNodeContent(j).length;if(h>=k.offset){l.elt=j;l.offset=k.offset-g;break;}j=j.nextSibling;}return l;};unpaintCommentScope=function(w){var x=w.id;var G="c-id-"+x;var u=[];var i=CY.all("."+G);if(i!=null){for(var y=0,C=i.size();y<C;y++){var n=i.item(y);if(n.hasClass("c-c")){var v=CY.Node.getDOMNode(n);_removeIdClass(v,x);var A=getCommentIdsFromClasses(v);quicksort(A);var E=n.get("previousSibling");if(E!=null){var D=CY.Node.getDOMNode(E);var F=getCommentIdsFromClasses(D);quicksort(F);if(areSortedArraysEqual(A,F)){_setTextNodeContent(v,_getTextNodeContent(D)+_getTextNodeContent(v));u.push(D);}}var B=n.get("nextSibling");if(B!=null){var p=CY.Node.getDOMNode(B);var z=getCommentIdsFromClasses(p);quicksort(z);if(areSortedArraysEqual(A,z)){v.firstChild.data=v.firstChild.data+p.firstChild.data;u.push(p);}}}else{alert("HAS NO c-c ? : "+commentNode.get("id")+" , innerHTML :"+commentNode.get("innerHTML"));return;}}}for(var y=0,C=u.length;y<C;y++){u[y].remove();}};unpaintAllComments=function(){var i=CY.all(".c-s");var o=[];for(var p=0,s=i.size();p<s;p++){var l=i.item(p);var r=l.get("firstChild");var m=CY.Node.getDOMNode(l.get("firstChild"));_removeIdClasses(m);var q=r.get("nextSibling");while(q!=null){var n=CY.Node.getDOMNode(q);m.firstChild.data=m.firstChild.data+n.firstChild.data;o.push(n);q=q.get("nextSibling");}}for(var p=0,s=o.length;p<s;p++){o[p].remove();}};showScope=function(d){var e=CY.all(".c-id-"+d);if(e!=null){e.addClass("c-scope");}};hideScopeAnyway=function(){var b=CY.all(".c-scope");if(b!=null){b.removeClass("c-scope");}};Db=function(){this.comments=null;this.allComments=null;this.commentsByDbId={};this.allCommentsByDbId={};this.ordered_comment_ids={};};Db.prototype={init:function(){this.allComments=CY.JSON.parse(sv_comments);if(sv_read_only){this.initToReadOnly();}this._computeAllCommentsByDbId();this._reorder();},_del:function(i,l,j){var k=l[j];for(var n=0;n<k.replies.length;n++){var m=k.replies[n].id;this._del(k.replies,l,m);n--;}for(var n=0,h=i.length;n<h;n++){if(i[n].id==j){i.splice(n,1);delete l[j];break;}}},del:function(d){var e=(d.reply_to_id==null)?this.comments:this.commentsByDbId[d.reply_to_id].replies;this._del(e,this.commentsByDbId,d.id);e=(d.reply_to_id==null)?this.allComments:this.allCommentsByDbId[d.reply_to_id].replies;this._del(e,this.allCommentsByDbId,d.id);this._reorder();},_reorder:function(){var r=[];for(var u=0,y=this.allComments.length;u<y;u++){var t=this.allComments[u];var a=false;for(var v=0,i=r.length;v<i;v++){var z=r[v];var w=this.allCommentsByDbId[z];if((t.start_wrapper<w.start_wrapper)||((t.start_wrapper==w.start_wrapper)&&(t.start_offset<w.start_offset))||((t.start_wrapper==w.start_wrapper)&&(t.start_offset==w.start_offset)&&(t.end_wrapper<w.end_wrapper))||((t.start_wrapper==w.start_wrapper)&&(t.start_offset==w.start_offset)&&(t.end_wrapper==w.end_wrapper)&&(t.end_offset<w.end_offset))){r.splice(v,0,t.id);a=true;break;}}if(!a){r.push(t.id);}}this.ordered_comment_ids.scope=r;r=[];var s={};for(var u=0,y=this.allComments.length;u<y;u++){var t=this.allComments[u];var q=t.modified;s[t.id]=this._latest_mod(t);}for(var z in s){var x=this.allCommentsByDbId[z].id;var a=false;for(var u=0,y=r.length;u<y;u++){var j=r[u];if(s[z]<s[j]){r.splice(u,0,x);a=true;break;}}if(!a){r.push(x);}}this.ordered_comment_ids.modif_thread=r;},_latest_mod:function(h){var g=h.modified;for(var f=0;f<h.replies.length;f++){var j=h.replies[f];var i=this._latest_mod(j);if(i>g){g=i;}}return g;},_upd:function(i,k,j){var l=false;for(var m=0,h=i.length;m<h;m++){if(i[m].id==j.id){i.splice(m,1,j);l=true;break;}}if(!l){i.push(j);}k[j.id]=j;},upd:function(f){var e=(f.reply_to_id==null)?this.allComments:this.allCommentsByDbId[f.reply_to_id].replies;this._upd(e,this.allCommentsByDbId,f);var d=CY.clone(f);e=(f.reply_to_id==null)?this.comments:this.commentsByDbId[f.reply_to_id].replies;this._upd(e,this.commentsByDbId,d);this._reorder();},initComments:function(g){this.comments=[];for(var i=0,j=this.allComments.length;i<j;i++){var f=CY.Array.indexOf(g,this.allComments[i].id);if(f!=-1){var h=CY.clone(this.allComments[i]);this.comments.push(h);}}this._computeCommentsByDbId();},_computeCommentsByDbId:function(){this.commentsByDbId={};var d=this.getThreads(this.comments);for(var e=0;e<d.length;e++){this.commentsByDbId[d[e].id]=d[e];}},_computeAllCommentsByDbId:function(){this.allCommentsByDbId={};var d=this.getThreads(this.allComments);for(var e=0;e<d.length;e++){this.allCommentsByDbId[d[e].id]=d[e];}},getThreads:function(f){var e=[];for(var d=0;d<f.length;d++){e.push(f[d]);if(f[d].replies.length>0){e=e.concat(this.getThreads(f[d].replies));}}return e;},_getPath:function(f,h){var g=[h];var i=h;while(i.reply_to_id!=null){i=f[i.reply_to_id];g.push(i);}return g;},getPath:function(b){return this._getPath(this.commentsByDbId,b);},getComment:function(b){return this.commentsByDbId[b];},getCommentByIdKey:function(e){for(var f in this.commentsByDbId){var d=this.commentsByDbId[f];if(d.id_key==e){return d;}}return null;},isChild:function(g,f){var h=this.commentsByDbId[g];var e=(g==f);while((!e)&&(h.reply_to_id!=null)){h=this.commentsByDbId[h.reply_to_id];e=(h.id==f);}return e;},initToReadOnly:function(i,h){for(var l=0,g=this.allComments.length;l<g;l++){var j=this.allComments[l];for(var k in j){if(0==k.indexOf("can_")&&typeof j[k]==="boolean"){j[k]=false;}}}},browsingIndex:function(e){var h={};for(var f in this.ordered_comment_ids){var g=CY.Array.filter(this.ordered_comment_ids[f],function(a){return(a in this.commentsByDbId);},this);h[f]=CY.Array.indexOf(g,e);}return h;},browse:function(i,l,o){var j=this.ordered_comment_ids[i];if(j.length>0){var p=-1;if((l=="prev")||(l=="next")){for(var m=0;m<j.length;m++){var k=j[m];if(k==o){p=(l=="prev")?m-1:m+1;p=(j.length+p)%j.length;break;}}if(p==-1){CY.error("internal error in db browse (was called with a dbId that isn't among the filtered ones)");return null;}}if(l=="last"){p=j.length-1;}if(l=="first"){p=0;}for(var m=p,n=0;(m>=0)&&(m<j.length);n++){var k=j[m];if(k in this.commentsByDbId){return this.commentsByDbId[k];}if((l=="prev")||(l=="last")){m=m-1;}else{m=m+1;}m=(j.length+m)%j.length;if(n>j.length){break;}}CY.error("internal error in db browse (could not find any filtered comment)");}return null;},computeFilterResults:function(V){var W={};if(V){for(key in V){if(key.indexOf("filter_")==0){W[key.substr("filter_".length)]=V[key];}}}else{if(gLayout.isInFrame()){W=parent.f_getFrameFilterData();}}var R=[];var G=[];var X="";if("name" in W){X=W.name;}this.filterByName(X,R,G);var L=[];var ac=[];var P="";if("date" in W){P=W.date;}this.filterByDate(P,L,ac);var ab=[];var ag=[];var N="";if("text" in W){N=W.text;}this.filterByText(N,ab,ag);var T=[];var S=[];var H="";if("tag" in W){H=W.tag;}this.filterByTag(H,T,S);var aj=[];var ae=[];var aa="";if("cat" in W){aa=W.cat;}this.filterByCat(aa,aj,ae);var I=[];var ad=[];var ah="";if("state" in W){ah=W.state;}this.filterByState(ah,I,ad);var af=[];var i=[];for(var U=0,Y=R.length;U<Y;U++){var K=R[U];if((CY.Array.indexOf(L,K)!=-1)&&(CY.Array.indexOf(ab,K)!=-1)&&(CY.Array.indexOf(T,K)!=-1)&&(CY.Array.indexOf(aj,K)!=-1)&&(CY.Array.indexOf(I,K)!=-1)){af.push(K);}}for(var U=0,Y=G.length;U<Y;U++){var K=G[U];if((CY.Array.indexOf(ac,K)!=-1)&&(CY.Array.indexOf(ag,K)!=-1)&&(CY.Array.indexOf(S,K)!=-1)&&(CY.Array.indexOf(ae,K)!=-1)&&(CY.Array.indexOf(ad,K)!=-1)){i.push(K);}}var M=i.length,ai=af.length;var O=ai;for(var U=0,Y=i.length;U<Y;U++){var K=i[U];var Q=this.allCommentsByDbId[K];var J=this._getPath(this.allCommentsByDbId,Q);var Z=J[J.length-1];var K=Z.id;if(CY.Array.indexOf(af,K)==-1){af.push(K);O++;}}return{commentIds:af,nbDiscussions:O,nbComments:ai,nbReplies:M};},filterByText:function(l,i,h){var g=new RegExp(l,"gi");for(var j in this.allCommentsByDbId){var k=this.allCommentsByDbId[j];if(l==""||g.exec(k.title)!=null||g.exec(k.content)!=null){if(k.reply_to_id==null){i.push(k.id);}else{h.push(k.id);}}}},filterByName:function(g,h,f){for(var i in this.allCommentsByDbId){var j=this.allCommentsByDbId[i];if(g==""||j.name==g){if(j.reply_to_id==null){h.push(j.id);}else{f.push(j.id);}}}},filterByTag:function(j,q,o){var k=new RegExp("^"+j+"$","");var l=new RegExp("^"+j+", ","");var n=new RegExp(", "+j+", ","");var p=new RegExp(", "+j+"$","");for(var r in this.allCommentsByDbId){var m=this.allCommentsByDbId[r];if((j=="")||k.exec(m.tags)!=null||l.exec(m.tags)!=null||n.exec(m.tags)!=null||p.exec(m.tags)!=null){if(m.reply_to_id==null){q.push(m.id);}else{o.push(m.id);}}}},filterByCat:function(h,i,l){for(var j in this.allCommentsByDbId){var k=this.allCommentsByDbId[j];if(h==undefined||h==""||k.category==h){if(k.reply_to_id==null){i.push(k.id);if(k.replies.length){for(var g in k.replies){l.push(k.replies[g].id);}}}}}},filterByState:function(j,g,f){for(var h in this.allCommentsByDbId){var i=this.allCommentsByDbId[h];if(j==""||i.state==j){if(i.reply_to_id==null){g.push(i.id);}else{f.push(i.id);}}}},filterByDate:function(h,k,l){var g=(h=="")?0:parseInt(h);for(var i in this.allCommentsByDbId){var j=this.allCommentsByDbId[i];if(j.modified>g){if(j.reply_to_id==null){k.push(j.id);}else{l.push(j.id);}}}},getCommentsAndRepliesCounts:function(k){var l=0;var i=0;var h=(k)?this.allComments:this.comments;var j=this.getThreads(h);for(var g=0;g<j.length;g++){if(j[g].reply_to_id==null){l++;}else{i++;}}return[l,i];},getCommentsNb:function(d){var e=(d)?this.allComments:this.comments;return this.getThreads(e).length;},getFilteredCommentIdsAsString:function(){var e="";for(var d in this.commentsByDbId){e=e+d+",";}return e;}};hasPerm=function(b){return(-1!=CY.Array.indexOf(sv_user_permissions,b));};gShowingAllComments=false;if(!Array.prototype.indexOf){Array.prototype.indexOf=function(h,g){for(var e=(g||0),f=this.length;e<f;e++){if(this[e]===h){return e;}}return -1;};}Sync=function(){this._q=null;this._iPreventClick=false;};safari_mobile=/iPhone|iPod|iPad/.test(navigator.userAgent);var the_scrolling_part=safari_mobile?"#maincontainer":"document";var add_comment_offset=30;Sync.prototype={init:function(b){this._q=new CY.AsyncQueue();},setPreventClickOn:function(){CY.log("setPreventClickOn !");if(gLayout.isInFrame()){parent.f_interfaceFreeze();}this._iPreventClick=true;},setPreventClickOff:function(){CY.log("setPreventClickOff !");if(gLayout.isInFrame()){parent.f_interfaceUnfreeze();}this._iPreventClick=false;},removeCommentRet:function(g){var i=g.successfull;var h=(i)?g.failure.iComment:g.success.iComment;if(i){var j=g.returned.filterData;if(gLayout.isInFrame()){parent.f_updateFilterData(j);}var k=gIComments.getTopPosition()[1];var l=gDb.getComment(h.commentId);this._q.add(function(){unpaintCommentScope(l);gIComments.close(l.id);gIComments.remove(l.id);if(l.reply_to_id!=null){gIComments.refresh(l.reply_to_id);}gDb.del(l);if(gLayout.isInFrame()){if(gDb.comments.length==0&&gDb.allComments.length!=0){parent.f_enqueueMsg(gettext("no filtered comments left"));parent.resetFilter();}else{var a=gDb.computeFilterResults();updateFilterResultsCount(a.nbDiscussions,a.nbComments,a.nbReplies);}}});this._animateTo(k);}this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this.resume();},moderateCommentRet:function(k){var i=k.successfull;var h=(i)?k.failure.iComment:k.success.iComment;if(i){var l=k.returned;var j=l.comment;gDb.upd(j);var g=gLayout.isInFrame()&&!parent.f_isFrameFilterFieldsInit();if(g){parent.resetFilter();this._showSingleComment(j);}else{h.changeModeration(j);}}this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this.resume();},saveCommentRet:function(p){var x=p.successfull;if(x){var o=p.success.formId;var q=p.returned;removeFormErrMsg(o);if("errors" in q){var n=q.errors;for(var u in n){addFormErrMsg(o,u,n[u]);}this._animateToTop();}else{var w=function(){return(gNewReply!=null)&&(o==gNewReply.ids.formId);};var t=function(){return(gICommentForm!=null)&&(o==gICommentForm.formId);};var v=function(){return(gEdit!=null)&&(o==gEdit.ids.formId);};if(t()){this.hideICommentForm(cleanICommentForm());}else{if(v()){this._hideEditForm();}else{if(w()){this._hideNewReplyForm();}}}if("ask_for_notification" in q){if(q.ask_for_notification){parent.f_yesNoDialog(gettext("Do you want to be notified of all replies in all discussions you participated in?"),gettext("Reply notification"),function(){var a={method:"POST",data:urlEncode({fun:"ownNotify",key:sv_key,version_key:sv_version_key,email:q.email,active:false})};CY.io(sv_client_url,a);},this,null,function(){var a={method:"POST",data:urlEncode({fun:"ownNotify",key:sv_key,version_key:sv_version_key,email:q.email,active:true})};CY.io(sv_client_url,a);},this,null);}}if("comment" in q){var s=q.comment;gDb.upd(s);var r=gLayout.isInFrame()&&parent.f_isFrameFilterFieldsInit();if(r){parent.resetFilter();}else{if(s.reply_to_id==null){unpaintCommentScope(s);paintCommentScope(s);}}var m=q.filterData;if(gLayout.isInFrame()){parent.f_updateFilterData(m);updateResetFilterResultsCount();}if(w()){if(!r){this._insertReply(s);}}else{this._showSingleComment(s);}}else{this._animateToTop();}}}else{this._q.add({id:"expl",fn:function(){CY.log("in example .........");}});this._q.promote("expl");}this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this.resume();},example:function(){CY.log("in example .........");},moderateComment:function(e,d){var f=gDb.getComment(e.commentId);this._q.add({fn:CY.bind(this.setPreventClickOn,this)},{autoContinue:false,fn:CY.bind(doExchange,null,"editComment",{comment_key:f.key,state:d},null,this.moderateCommentRet,this,{iComment:e},gettext("could not save comment"))}).run();},_saveComment:function(d,e){this._q.add({fn:CY.bind(this.setPreventClickOn,this)},{autoContinue:false,fn:CY.bind(doExchange,null,d,{},e,this.saveCommentRet,this,{formId:e},gettext("could not save comment"))}).run();},editComment:function(){this._saveComment("editComment",gEdit.ids.formId);},saveComment:function(b){if(readyForAction()){this._saveComment("addComment",b);}},removeComment:function(b){checkForOpenedDialog(b,function(){if(gLayout.isInFrame()){parent.f_yesNoDialog(gettext("Are you sure you want to delete this comment?"),gettext("Warning"),function(){this.animateToTop();},this,null,function(){var a=gDb.getComment(b.commentId);this._q.add({fn:CY.bind(this.setPreventClickOn,this)},{autoContinue:false,fn:CY.bind(doExchange,null,"removeComment",{comment_key:a.key},null,this.removeCommentRet,this,{iComment:b},gettext("could not remove comment"))}).run();},this,null);}},this,null);},resume:function(d,e){this._q.run();},resetAutoContinue:function(b){this._q.getCallback(b).autoContinue=true;},hideICommentForm:function(b){this._q.add({autoContinue:false,fn:CY.bind(gICommentForm.animationHide.run,gICommentForm.animationHide)});if(b){this._q.add(b);}},showCommentForm:function(b){checkForOpenedDialog(null,function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){if(b==null){var a=getSelectionInfo();updateICommentFormSelection(a);}showICommentForm(b);}});this._q.add({autoContinue:false,fn:CY.bind(gICommentForm.animationShow.run,gICommentForm.animationShow)},{fn:CY.bind(this.setPreventClickOff,this)}).run();},this,null);},showEditForm:function(b){checkForOpenedDialog(null,function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){showEditForm(b);}});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},this,null);},showReplyForm:function(b){checkForOpenedDialog(null,function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){instanciateNewReplyForm(b);}});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},this,null);},cancelICommentForm:function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this.hideICommentForm();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},cancelEdit:function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){cancelEditForm();}});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},cancelReply:function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){cancelNewReplyForm();}});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},changeScopeFormClick:function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._q.add({fn:function(){changeScopeFormClick();}});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},_hideNewReplyForm:function(){this._q.add({fn:function(){cleanNewReplyForm();cancelNewReplyForm();}});},_hideEditForm:function(){this._q.add({fn:function(){cancelEditForm();}});},_insertReply:function(b){this._q.add({fn:function(){var j=gDb.getComment(b.reply_to_id);var m=gDb.getThreads([j]);var k=m[m.length-2];var n=gIComments.insertAfter(k,b);var i=gIComments.getPosition(b.reply_to_id);n.setPosition(i);var a=gDb.getPath(b);var l=a[a.length-1];if(gIComments.isTopActive(l.id)){n.activate();}n.show();}});this._animateToTop();},_showSingleComment:function(g){if(g!=null){var h=gDb.getPath(g);var e=h[h.length-1];var f=0;if(g.start_wrapper!=-1){f=CY.one(".c-id-"+e.id).getY();}else{f=CY.one(the_scrolling_part).get("scrollTop");}this._showComments([e.id],f,false);if(e.replies.length>0){this._animateTo();}}},_showFocusSingleComment:function(g,h,e){if(g!=null){var f=0;if(g.start_wrapper!=-1){f=CY.one(".c-id-"+g.id).getY();}else{f=CY.one(the_scrolling_part).get("scrollTop");}this._showComments([g.id],f,false);if(g.replies.length>0||e){this._animateToAndFocus(f,h.id,e);}}},showSingleComment:function(b){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._showSingleComment(b);this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},showFocusSingleComment:function(f,d,e){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._showFocusSingleComment(f,d,e);this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},browse:function(e,d){var f=gIComments.browse(e,d);if(f!=null){this.showSingleComment(f);}},_showComments:function(f,d,e){this._q.add({fn:function(){gShowingAllComments=e;gIComments.hide();hideToc();var g=CY.Array.map(f,function(h){return gDb.getComment(h);});var b=gDb.getThreads(g);gIComments.fetch(b);if(f.length>0){if(e){CY.one(the_scrolling_part).set("scrollTop",0);}else{gIComments.activate(f[0]);var a=CY.one(".c-id-"+f[0]);if(a&&!a.inViewportRegion()){a.scrollIntoView(true);if(parent){parent.document.getElementById("outer-north").scrollIntoView(true);}if(safari_mobile){d=add_comment_offset;}else{d+=add_comment_offset;}}}}gIComments.setPosition([gConf.iCommentLeftPadding,d]);gIComments.show();}});},_animateTo:function(b){this._q.add({fn:function(){gIComments.setAnimationToPositions(b);}},{id:"animationRun",autoContinue:false,fn:CY.bind(gIComments.runAnimations,gIComments)});},_animateToAndFocus:function(e,f,d){this._q.add({fn:function(){gIComments.setAnimationToPositionsAndFocus(e,f,d);}},{id:"animationRun",autoContinue:false,fn:CY.bind(gIComments.runAnimations,gIComments)});},_animateToTop:function(){var b=gIComments.getTopPosition();if(b!=null){this._animateTo(b[1]);}},animateToTop:function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._animateToTop();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},showAllComments:function(){checkForOpenedDialog(null,function(){gShowingAllComments=true;var b=CY.Array.map(gDb.comments,function(a){return a.id;});if(parent.$("#browse_by").val()=="scope"){b.sort(function(a,e){if(gDb.ordered_comment_ids.scope.indexOf(a)<gDb.ordered_comment_ids.scope.indexOf(e)){return -1;}if(gDb.ordered_comment_ids.scope.indexOf(a)>gDb.ordered_comment_ids.scope.indexOf(e)){return 1;}return 0;});}this.showComments(b,[0,add_comment_offset],true);},this,null);},showScopeRemovedComments:function(){checkForOpenedDialog(null,function(){gShowingAllComments=true;var d=CY.Array.filter(gDb.comments,function(a){return(a.start_wrapper==-1);});var e=CY.Array.map(d,function(a){return a.id;});if(parent.$("#browse_by").val()=="scope"){e.sort(function(a,b){if(gDb.ordered_comment_ids.scope.indexOf(a)<gDb.ordered_comment_ids.scope.indexOf(b)){return -1;}if(gDb.ordered_comment_ids.scope.indexOf(a)>gDb.ordered_comment_ids.scope.indexOf(b)){return 1;}return 0;});}this.showComments(e,[0,add_comment_offset],true);},this,null);},showComments:function(f,d,e){checkForOpenedDialog(null,function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});this._showComments(f,d[1],e);this._animateTo();this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},this,null);},openComment:function(e){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});var d=gIComments.getTopPosition()[1];this._q.add({fn:function(){gIComments.open(e.commentId);gIComments.refresh(e.commentId);}});this._animateTo(d);this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},closeComment:function(b){checkForOpenedDialog(b,function(){this._q.add({fn:CY.bind(this.setPreventClickOn,this)});var a=gIComments.getTopPosition()[1];this._q.add({fn:function(){var d=gDb.getComment(b.commentId);gIComments.close(b.commentId);if(d.reply_to_id!=null){gIComments.refresh(d.reply_to_id);}}});this._animateTo(a);this._q.add({fn:CY.bind(this.setPreventClickOff,this)});this._q.run();},this,null);},activate:function(b){gIComments.activate(b.commentId);}};readyForAction=function(){return !gSync._iPreventClick;};gEditICommentHost=null;gEdit=null;dbgc=null;showEditForm=function(h){if(gEdit==null){gEdit={ids:{formId:CY.guid(),formTitleId:CY.guid(),nameInputId:CY.guid(),emailInputId:CY.guid(),titleInputId:CY.guid(),contentInputId:CY.guid(),tagsInputId:CY.guid(),categoryInputId:CY.guid(),formatInputId:CY.guid(),startWrapperInputId:CY.guid(),endWrapperInputId:CY.guid(),startOffsetInputId:CY.guid(),endOffsetInputId:CY.guid(),changeScopeInputId:CY.guid(),changeScopeInputWrapper:CY.guid(),selectionPlaceId:CY.guid(),keyId:CY.guid(),editCommentId:CY.guid(),currentSelId:CY.guid(),currentSelIdI:CY.guid(),addBtnId:CY.guid(),cancelBtnId:CY.guid()},handlers:{}};}gEditICommentHost=h;gEditICommentHost.hideContent();var l=getHtml(gEdit.ids);var g='<div class="icomment-edit-header">'+l.headerContent+"</div>";var j='<div class="icomment-edit-body">'+l.bodyContent+"</div>";gEditICommentHost.overlay.setStdModContent(CY.WidgetStdMod.HEADER,CY.Node.create(g),CY.WidgetStdMod.AFTER);gEditICommentHost.overlay.setStdModContent(CY.WidgetStdMod.BODY,CY.Node.create(j),CY.WidgetStdMod.AFTER);CY.one("#"+gEdit.ids.formTitleId).set("innerHTML",gettext("Edit comment"));var i=gDb.getComment(gEditICommentHost.commentId);CY.one("#"+gEdit.ids.editCommentId).set("value",i.id);CY.one("#"+gEdit.ids.keyId).set("value",i.key);CY.one("#"+gEdit.ids.changeScopeInputId+" input").set("checked",false);if(i.reply_to_id!=null){CY.one("#"+gEdit.ids.changeScopeInputId).addClass("displaynone");if(CY.one("#"+gEdit.ids.categoryInputId)){CY.one("#"+gEdit.ids.categoryInputId).addClass("displaynone");CY.one("#"+gEdit.ids.categoryInputId).ancestor().addClass("displaynone");}}changeScopeFormClick();CY.one("#"+gEdit.ids.nameInputId).set("value",i.name);CY.one("#"+gEdit.ids.emailInputId).set("value",i.email);if(i.logged_author){CY.one("#"+gEdit.ids.nameInputId).setAttribute("disabled",true);CY.one("#"+gEdit.ids.emailInputId).setAttribute("disabled",true);}CY.one("#"+gEdit.ids.titleInputId).set("value",i.title);CY.one("#"+gEdit.ids.contentInputId).set("value",i.content);CY.one("#"+gEdit.ids.tagsInputId).set("value",i.tags);if(CY.one("#"+gEdit.ids.categoryInputId)){CY.one("#"+gEdit.ids.categoryInputId).set("value",i.category);}CY.one("#"+gEdit.ids.formatInputId).set("value",gConf.defaultCommentFormat);var k=gLayout.getTopICommentsWidth();changeFormFieldsWidth(gEdit.ids.formId,k);gEdit.handlers.addBtnId=CY.on("click",onEditSaveClick,"#"+gEdit.ids.addBtnId);gEdit.handlers.cancelBtnId=CY.on("click",onEditCancelClick,"#"+gEdit.ids.cancelBtnId);gEdit.handlers.changeScope=CY.on("click",onChangeScopeClick,"#"+gEdit.ids.changeScopeInputId);};onEditSaveClick=function(b){if(readyForAction()){gSync.editComment();}};onEditCancelClick=function(b){if(readyForAction()){gSync.cancelEdit();}};onChangeScopeClick=function(){if(readyForAction()){gSync.changeScopeFormClick();}else{var e=CY.one("#"+gEdit.ids.changeScopeInputId+" input");var d=e.get("checked");e.set("checked",!d);}};changeScopeFormClick=function(){var b=CY.one("#"+gEdit.ids.currentSelId);if(CY.one("#"+gEdit.ids.changeScopeInputId+" input").get("checked")){b.removeClass("displaynone");}else{b.addClass("displaynone");}};cancelEditForm=function(){if(gEditICommentHost!=null){for(var b in gEdit.handlers){if(gEdit.handlers[b]!=null){gEdit.handlers[b].detach();gEdit.handlers[b]=null;}}gEditICommentHost.overlay.get("contentBox").one(".icomment-edit-body").remove();gEditICommentHost.overlay.get("contentBox").one(".icomment-edit-header").remove();gEditICommentHost.showContent();gEditICommentHost=null;}};IComment=function(){this.commentId=null;var B=gLayout.getTopICommentsWidth();var M=gConf.iCommentLeftPadding;var x=gettext("change comment state to pending");var C=gettext("change comment state to approved");var H=gettext("change comment state to unapproved");var y=gettext("cancel changing the state of this comment");var K=gettext("pending");var J=gettext("approved");var u=gettext("unapproved");var I=gettext("cancel");var z=gettext("show replies");var w=gettext("change to:");var E=ngettext("reply","replies",1);var L=gettext("edit comment");var F=gettext("delete comment");var A=gettext("edit");var G=gettext("delete");var D=gettext("close");var N=gettext("show scope");var v=gettext("Comment is detached: it was created on a previous version and text it applied to has been modified or removed.");this.overlay=new CY.Overlay({zIndex:3,shim:false,visible:false,width:B,xy:[M,0],headerContent:'<div class="icomment-header"><div class="c-iactions"><a class="c-moderate c-action" title="">vis</a> <a class="c-edit c-action" title="'+L+'" alt="'+L+'">'+A+'</a> <a class="c-delete c-action" title="'+F+'" alt="'+F+'">'+G+'</a> </div><div class="c-state-actions displaynone">'+w+'&nbsp;<a class="c-state-pending c-action" title="'+x+'" alt="'+x+'">'+K+'</a> <a class="c-state-approved c-action" title="'+C+'" alt="'+C+'">'+J+'</a> <a class="c-state-unapproved c-action" title="'+H+'" alt="'+H+'">'+u+'</a> <a class="c-state-cancel c-action" title="'+y+'" alt="'+y+'">'+I+'</a> </div><div class="c-no-scope-msg">'+v+'</div><a class="c-show-scope c-action" title="'+N+'" alt="'+N+'"><em>-</em></a><a class="c-close c-action" title="'+D+'" alt="'+D+'"><em>X</em></a></div>',bodyContent:'<div class="icomment-body"><span class="c-content"></span><span class="c-ireplyactions"><a class="c-readreplies c-action" title="'+z+'" alt="'+z+'">'+z+'</a> <a class="c-reply c-action" title="'+E+'" alt="'+E+'">'+E+"</a>&nbsp;</span></div>"});this.overlay.get("contentBox").addClass("c-comment");this.overlay.render("#leftcolumn");this.animation=new CY.Anim({node:this.overlay.get("boundingBox"),duration:gPrefs.get("general","animduration"),easing:CY.Easing.easeOut});this.overlay.get("contentBox").one(".c-close").on("click",this.onCloseCommentClick,this);this.overlay.get("contentBox").one(".c-moderate").on("click",this.onModerateCommentClick,this);this.overlay.get("contentBox").one(".c-state-pending").on("click",this.onPendingCommentClick,this);this.overlay.get("contentBox").one(".c-state-approved").on("click",this.onApprovedCommentClick,this);this.overlay.get("contentBox").one(".c-state-unapproved").on("click",this.onUnapprovedCommentClick,this);this.overlay.get("contentBox").one(".c-state-cancel").on("click",this.onCancelStateChangeClick,this);this.overlay.get("contentBox").one(".c-edit").on("click",this.onEditCommentClick,this);this.overlay.get("contentBox").one(".c-delete").on("click",this.onDeleteCommentClick,this);this.overlay.get("contentBox").one(".c-reply").on("click",this.onReplyCommentClick,this);this.overlay.get("contentBox").one(".c-readreplies").on("click",this.onReadRepliesCommentClick,this);this.overlay.get("contentBox").one(".icomment-header").on("mouseenter",this.onMouseEnterHeader,this);this.overlay.get("contentBox").one(".icomment-header").on("mouseleave",this.onMouseLeaveHeader,this);this.overlay.get("contentBox").on("click",this.onCommentClick,this);};IComment.prototype={onCloseCommentClick:function(b){b.halt();if(readyForAction()&&this.isVisible()){gSync.closeComment(this);}},onModerateCommentClick:function(b){b.halt();if(readyForAction()&&this.isVisible()){this.overlay.get("contentBox").one(".c-iactions").addClass("displaynone");this.overlay.get("contentBox").one(".c-state-actions").removeClass("displaynone");}},onPendingCommentClick:function(b){b.halt();if(readyForAction()&&this.isVisible()){gSync.moderateComment(this,"pending");}},onApprovedCommentClick:function(b){b.halt();if(readyForAction()&&this.isVisible()){gSync.moderateComment(this,"approved");}},onUnapprovedCommentClick:function(b){b.halt();if(readyForAction()&&this.isVisible()){gSync.moderateComment(this,"unapproved");}},onCancelStateChangeClick:function(b){b.halt();if(readyForAction()&&this.isVisible()){this.overlay.get("contentBox").one(".c-iactions").removeClass("displaynone");this.overlay.get("contentBox").one(".c-state-actions").addClass("displaynone");}},onDeleteCommentClick:function(b){b.halt();if(readyForAction()&&this.isVisible()){gSync.removeComment(this);}},onEditCommentClick:function(b){b.halt();if(readyForAction()&&this.isVisible()){gSync.showEditForm(this);}},onReplyCommentClick:function(b){b.halt();if(readyForAction()&&this.isVisible()){gSync.showReplyForm(this);}},onReadRepliesCommentClick:function(b){b.halt();if(readyForAction()&&this.isVisible()){gSync.openComment(this);}},onCommentClick:function(j){if(readyForAction()&&this.isVisible()){if(j.target.get("target")=="_blank"){var l=j.target;var k=sv_site_url+sv_text_view_show_comment_url;if(l.get("href").indexOf(k)==0){var e=(new RegExp("comment_id_key=([^&]*)","g")).exec(l.get("href"));if(e!=null){var h=e[1];var i=gDb.getCommentByIdKey(h);if(i!=null){j.halt();if(!l.hasClass("c-permalink")){checkForOpenedDialog(null,function(){gSync.showSingleComment(i);});}}}}}else{if(gShowingAllComments){if(!this._isHostingAForm()){var i=gDb.getComment(this.commentId);checkForOpenedDialog(null,function(){if(i!=null){gSync.showSingleComment(i);}});}}else{gSync.activate(this);}}}},onMouseEnterHeader:function(){if(readyForAction()&&this.isVisible()){this.overlay.get("contentBox").one(".c-permalink").removeClass("displaynone");}},onMouseLeaveHeader:function(){if(readyForAction()&&this.isVisible()){this.overlay.get("contentBox").one(".c-permalink").addClass("displaynone");}},setWidth:function(b){this.overlay.get("boundingBox").setStyle("width",b+"px");},activate:function(){this.overlay.get("boundingBox").addClass("c-focus-comment");},deactivate:function(){this.overlay.get("boundingBox").removeClass("c-focus-comment");},hide:function(){if(gIComments.isTopActive(this.commentId)){if(!gIComments.activateVisibleNext()){gIComments.deactivate();}}if(this.isVisible()){this.overlay.hide();this.overlay.blur();}},hideContent:function(){this.overlay.get("contentBox").one(".icomment-header").addClass("displaynone");this.overlay.get("contentBox").one(".icomment-body").addClass("displaynone");},showContent:function(){this.overlay.get("contentBox").one(".icomment-header").removeClass("displaynone");this.overlay.get("contentBox").one(".icomment-body").removeClass("displaynone");},isVisible:function(){return this.overlay.get("visible");},show:function(){this.hideReadRepliesLnk();return this.overlay.show();},showReadRepliesLnk:function(){this.overlay.get("contentBox").one(".c-readreplies").removeClass("displaynone");},hideReadRepliesLnk:function(){this.overlay.get("contentBox").one(".c-readreplies").addClass("displaynone");},changeModeration:function(d){var e=this.overlay.get("contentBox").one(".c-moderate");e.set("innerHTML",gettext(d.state));e.removeClass("c-state-approved");e.removeClass("c-state-pending");e.removeClass("c-state-unapproved");e.addClass("c-state-"+d.state);this.overlay.get("contentBox").one(".c-iactions").removeClass("displaynone");this.overlay.get("contentBox").one(".c-state-actions").addClass("displaynone");},isfetched:function(){return(this.commentId!=null);},unfetch:function(){this.commentId=null;},fetch:function(x){this.commentId=x.id;var y=this.overlay.get("boundingBox");if(x.start_wrapper!=-1){y.addClass("c-has-scope");y.removeClass("c-has-no-scope");}else{y.addClass("c-has-no-scope");y.removeClass("c-has-scope");}if(x.reply_to_id!=null){y.addClass("c-is-reply");}else{y.removeClass("c-is-reply");}var C=interpolate(gettext("last modified on %(date)s"),{date:x.modified_user_str},true);var u=(x.modified==x.created)?"":'<a title="'+C+'"> * </a>';var H=gettext("Permalink to this comment");var s='<a class="c-permalink displaynone c-action" target="_blank" title="'+H+'" href="" >¶&nbsp;</a>';var w=interpolate(gettext("by %(name)s, created on %(date)s"),{name:x.name,date:x.created_user_str},true);var D='<span class="c-header"><div class="c-header-title">'+x.title+s+'</div><div class="c-infos">'+w+"</div></span>";var A=CY.Node.create(D);var r=y.one(".c-header");if(r==null){y.one(".icomment-header").insertBefore(A,y.one(".c-iactions"));}else{r.get("parentNode").replaceChild(A,r);}var E=CY.Node.create('<div class="c-tags"><span class="c-tags-infos">tags:</span>'+x.tags+"</div>");var t=y.one(".c-tags");if(t==null){y.one(".icomment-header").appendChild(E);}else{t.get("parentNode").replaceChild(E,t);}if(x.tags==""){E.addClass("displaynone");}var F=CY.Node.create('<div class="c-cat">'+gettext("category")+':&nbsp;<span class="c-cat-val c-cat-'+x.category+'">'+categories[x.category]+"</span></div>");var G=y.one(".c-cat");if(G==null){y.one(".icomment-header").appendChild(F);}else{G.get("parentNode").replaceChild(F,G);}if(x.category==0){F.addClass("displaynone");}var B=CY.Node.create('<span class="c-content">'+x.content_html+"</span>");var z=y.one(".c-content");if(z==null){y.one(".icomment-body").appendChild(B);}else{z.get("parentNode").replaceChild(B,z);}if(sv_prefix==""){y.one(".c-permalink").set("href",sv_site_url+x.permalink);}else{comment_id_delta_prefix=sv_delta!=""?Array(parseInt(sv_delta)+1).join(","):"";y.one(".c-permalink").set("href",top.location.protocol+"//"+top.location.hostname+top.location.pathname+"?comment_id_key="+comment_id_delta_prefix+x.id_key);}this.changeModeration(x);var v=y.all(".c-content a");if(v!=null){v.setAttribute("target","_blank");}v=y.all(".c-header-title a");if(v!=null){v.setAttribute("target","_blank");}this.permAdapt(x);},permAdapt:function(h){var i=this.overlay.get("contentBox").one(".c-delete");if(i){if(!h.can_delete){i.addClass("displaynone");}else{i.removeClass("displaynone");}}var j=this.overlay.get("contentBox").one(".c-edit");if(j){if(!h.can_edit){j.addClass("displaynone");}else{j.removeClass("displaynone");}}var g=this.overlay.get("contentBox").one(".c-reply");if(g){if(!hasPerm("can_create_comment")){g.addClass("displaynone");}else{g.removeClass("displaynone");}}var f=this.overlay.get("contentBox").one(".c-moderate");if(f){if(!h.can_moderate){f.addClass("displaynone");}else{f.removeClass("displaynone");}}},setThreadPad:function(b){this.overlay.get("contentBox").one(".yui-widget-hd").setStyle("paddingLeft",b+"px");this.overlay.get("contentBox").one(".yui-widget-bd").setStyle("paddingLeft",b+"px");},setPosition:function(d){var e=this.overlay.get("boundingBox");e.setStyle("opacity",1);e.setXY(d);},getPosition:function(d){var e=this.overlay.get("boundingBox");return e.getXY();},onAnimationEnd:function(){if(!CY.Lang.isUndefined(this["animation-handle"])&&!CY.Lang.isNull(this["animation-handle"])){this["animation-handle"].detach();this["animation-handle"]=null;}gIComments.signalAnimationEnd();if(gIComments.animationsEnded()){gIComments.whenAnimationsEnd();}},onAnimationEndFocus:function(){if(!CY.Lang.isUndefined(this["animation-handle"])&&!CY.Lang.isNull(this["animation-handle"])){this["animation-handle"].detach();this["animation-handle"]=null;}gIComments.signalAnimationEnd();if(gIComments.animationsEnded()){gIComments.whenAnimationsEndFocus();}},onAnimationEndReply:function(){if(!CY.Lang.isUndefined(this["animation-handle"])&&!CY.Lang.isNull(this["animation-handle"])){this["animation-handle"].detach();this["animation-handle"]=null;}gIComments.signalAnimationEnd();if(gIComments.animationsEnded()){gIComments.whenAnimationsEndReply();}},setAnimationToPosition:function(g,f,h){var e=this.overlay.get("boundingBox");if(gPrefs.get("general","animduration")<0.011){e.setXY(g);}this.animation.set("to",{xy:g});this.animation.set("duration",gPrefs.get("general","animduration"));if(f){if(h){this["animation-handle"]=this.animation.on("end",this.onAnimationEndReply,this);}else{this["animation-handle"]=this.animation.on("end",this.onAnimationEndFocus,this);}}else{this["animation-handle"]=this.animation.on("end",this.onAnimationEnd,this);}return this.animation;},getHeight:function(){return this.overlay.get("boundingBox").get("offsetHeight");},scrollIntoView:function(){if(!this.overlay.get("contentBox").inViewportRegion()){this.overlay.get("contentBox").scrollIntoView(true);}},_isHostingAForm:function(){return(this.isVisible()&&((gNewReplyHost!=null&&gNewReplyHost==this)||(gEditICommentHost!=null&&gEditICommentHost==this)));}};gToc=null;instanciateToc=function(){gToc={tocId:CY.guid(),tocTitleId:CY.guid(),closeBtnId:CY.guid(),empty:false};var n={};n.headerContent='<div id="'+gToc.tocId+'"><h3 id="'+gToc.tocTitleId+'"></h3>';var t=getElementsByTagNames("h2,h3,h4,h5,h6",document.getElementById("maincontainer"));var m=document.createElement("div");if(t.length>=2){for(var o=0;o<t.length;o++){var p=document.createElement("a");p.innerHTML=t[o].innerHTML.replace(/<\/?a[^>]*>/ig,"");p.className="page indent"+t[o].nodeName;m.appendChild(p);var l=t[o].id||"link"+o;p.href="#"+l;t[o].id=l;}}else{m.innerHTML="";gToc.empty=true;}n.bodyContent=m.innerHTML;var s=gLayout.getTopICommentsWidth();s+=gLayout.iCommentsRequiredThreadPadding();var q=new CY.Overlay({zIndex:3,shim:false,visible:false,headerContent:n.headerContent,bodyContent:n.bodyContent,xy:[3,30],width:s});q.get("contentBox").addClass("c-toc");q.get("contentBox").set("id","the-toc");q.render("#leftcolumn");CY.one("#"+gToc.tocTitleId).set("innerHTML",gettext("Table of contents"));gToc.overlay=q;var i=null;i=new CY.Anim({node:q.get("boundingBox"),duration:0.3,easing:CY.Easing.easeOut});gToc.animationHide=i;i.set("to",{opacity:0});gToc["animationHide-handle"]=i.on("end",onTocHideAnimEnd,gToc);var r=null;r=new CY.Anim({node:q.get("boundingBox"),duration:0.3,easing:CY.Easing.easeOut});gToc.animationShow=r;r.set("to",{opacity:1});gToc["animationShow-handle"]=r.on("end",onTocShowAnimEnd,gToc);getElementsByClassName("c-toc")[0].style.width=s+"px";};toggleTocFn=function(){if(isTocVisible()){hideToc();}else{showToc();}};hideToc=function(){gToc.overlay.hide();};onTocHideAnimEnd=function(){this.overlay.hide();gSync.resume();};onTocShowAnimEnd=function(){gSync.resume();};showToc=function(){removeFormErrMsg(gToc.tocId);gIComments.hide();gToc.overlay.show();};isTocVisible=function(){if(gToc!=null){return gToc.overlay.get("visible");}return false;};function getElementsByTagNames(l,k){if(!k){var k=document;}var m=l.split(",");var j=new Array();for(var n=0;n<m.length;n++){var p=k.getElementsByTagName(m[n]);for(var i=0;i<p.length;i++){j.push(p[i]);}}var o=j[0];if(!o){return[];}if(o.sourceIndex){j.sort(function(a,b){return a.sourceIndex-b.sourceIndex;});}else{if(o.compareDocumentPosition){j.sort(function(a,b){return 3-(a.compareDocumentPosition(b)&6);});}}return j;}var getElementsByClassName=function(d,e,f){if(document.getElementsByClassName){getElementsByClassName=function(s,a,o){o=o||document;var n=o.getElementsByClassName(s),b=(a)?new RegExp("\\b"+a+"\\b","i"):null,r=[],p;for(var q=0,i=n.length;q<i;q+=1){p=n[q];if(!b||b.test(p.nodeName)){r.push(p);}}return r;};}else{if(document.evaluate){getElementsByClassName=function(B,a,t){a=a||"*";t=t||document;var z=B.split(" "),b="",v="http://www.w3.org/1999/xhtml",j=(document.documentElement.namespaceURI===v)?v:null,x=[],s,A;for(var y=0,w=z.length;y<w;y+=1){b+="[contains(concat(' ', @class, ' '), ' "+z[y]+" ')]";}try{s=document.evaluate(".//"+a+b,t,j,0,null);}catch(u){s=document.evaluate(".//"+a+b,t,null,0,null);}while((A=s.iterateNext())){x.push(A);}return x;};}else{getElementsByClassName=function(A,C,b){C=C||"*";b=b||document;var x=A.split(" "),D=[],a=(C==="*"&&b.all)?b.all:b.getElementsByTagName(C),k,m=[],l;for(var w=0,B=x.length;w<B;w+=1){D.push(new RegExp("(^|\\s)"+x[w]+"(\\s|$)"));}for(var y=0,E=a.length;y<E;y+=1){k=a[y];l=false;for(var z=0,v=D.length;z<v;z+=1){l=D[z].test(k.className);if(!l){break;}}if(l){m.push(k);}}return m;};}}return getElementsByClassName(d,e,f);};var gtest={renaud:"RENAUD",random:Math.random(),bernard:"BERNARD",myFunc:function(){doExchange("theServerFun",{},null,this.myRetFunc,this,["foo","bar"]);},myRetFunc:function(b){CY.log("this.renaud : "+this.renaud);CY.log("this.random : "+this.random);CY.log("arg.returned : "+b.returned);CY.log(b.returned);CY.log("arg.success : "+b.success);CY.log(b.success);}};doExchange=function(k,n,l,m,o,p,i){n.fun=k;n.key=sv_key;n.version_key=sv_version_key;var j={method:"POST",data:urlEncode(n),on:{success:function(a,b,d){var e={};if(b.responseText){e=CY.JSON.parse(b.responseText);}if(gLayout.isInFrame()&&("msg" in e)){parent.f_enqueueMsg(e.msg);}d.returned=e;d.successfull=true;m.call(o,d);},failure:function(a,b,d){if(gLayout.isInFrame()){parent.f_enqueueErrorMsg(gettext("error:")+i);}d.successfull=false;m.call(o,d);}},arguments:{success:p,failure:p}};if(l!=null){j.form={id:l};}CY.io(sv_client_url,j);};warn_server=function(f){f.fun="warn";f.key=sv_key;f.version_key=sv_version_key;var d=CY.UA;var e={method:"POST",data:urlEncode(CY.merge(f,d))};CY.io("/client/",e);};gICommentForm=null;instanciateICommentForm=function(){gICommentForm={position:[CY.WidgetPositionAlign.TL,CY.WidgetPositionAlign.TL],formId:CY.guid(),formTitleId:CY.guid(),titleInputId:CY.guid(),contentInputId:CY.guid(),tagsInputId:CY.guid(),categoryInputId:CY.guid(),formatInputId:CY.guid(),startWrapperInputId:CY.guid(),endWrapperInputId:CY.guid(),startOffsetInputId:CY.guid(),endOffsetInputId:CY.guid(),selectionPlaceId:CY.guid(),keyId:CY.guid(),currentSelId:CY.guid(),currentSelIdI:CY.guid(),addBtnId:CY.guid(),cancelBtnId:CY.guid(),closeBtnId:CY.guid()};if(!sv_loggedIn){gICommentForm.nameInputId=CY.guid();gICommentForm.emailInputId=CY.guid();}var c=getHtml(gICommentForm);var e=gLayout.getTopICommentsWidth();e+=gLayout.iCommentsRequiredThreadPadding();var b=new CY.Overlay({zIndex:3,shim:false,visible:false,headerContent:c.headerContent,bodyContent:c.bodyContent,xy:[10,10],width:e});b.get("contentBox").addClass("c-newcomment");b.render("#leftcolumn");if(!sv_loggedIn){CY.one("#"+gICommentForm.nameInputId).set("value",gPrefs.get("user","name"));CY.one("#"+gICommentForm.emailInputId).set("value",gPrefs.get("user","email"));}CY.one("#"+gICommentForm.formTitleId).set("innerHTML",gettext("New comment"));CY.one("#"+gICommentForm.formatInputId).set("value",gConf.defaultCommentFormat);CY.on("click",onSubmitICommentFormClick,"#"+gICommentForm.addBtnId);CY.on("click",onCancelICommentFormClick,"#"+gICommentForm.cancelBtnId);CY.on("click",onCancelICommentFormClick,"#"+gICommentForm.closeBtnId);gICommentForm.overlay=b;var d=null;d=new CY.Anim({node:b.get("boundingBox"),duration:0.3,easing:CY.Easing.easeOut});gICommentForm.animationHide=d;d.set("to",{opacity:0});gICommentForm["animationHide-handle"]=d.on("end",onICommentFormHideAnimEnd,gICommentForm);var a=null;a=new CY.Anim({node:b.get("boundingBox"),duration:0.3,easing:CY.Easing.easeOut});gICommentForm.animationShow=a;a.set("to",{opacity:1});gICommentForm["animationShow-handle"]=a.on("end",onICommentFormShowAnimEnd,gICommentForm);changeFormFieldsWidth(gICommentForm.formId,e);};cleanICommentForm=function(){CY.one("#"+gICommentForm.currentSelIdI).set("innerHTML",gNoSelectionYet);var a=gICommentForm.overlay.getStdModNode(CY.WidgetStdMod.BODY);a.all(".comment_input").set("value","");CY.one("#"+gICommentForm.formatInputId).set("value",gConf.defaultCommentFormat);if(!sv_loggedIn){a.all(".user_input").set("value","");}};onICommentFormHideAnimEnd=function(){this.overlay.hide();gSync.resume();};onICommentFormShowAnimEnd=function(){gSync.resume();};onSubmitICommentFormClick=function(){if(!sv_loggedIn){var b=CY.one("#"+gICommentForm.nameInputId).get("value");gPrefs.persist("user","name",b);var a=CY.one("#"+gICommentForm.emailInputId).get("value");gPrefs.persist("user","email",a);}gSync.saveComment(gICommentForm.formId);};onCancelICommentFormClick=function(){gSync.cancelICommentForm();};_updateICommentFormSelection=function(c,e,b,a){var d=CY.Node.one("#"+c.currentSelIdI);if(d!=null){d.set("innerHTML",e);}d=CY.one("#"+c.startWrapperInputId);if(d!=null){d.set("value",b.elt.id.substring("sv_".length));}d=CY.one("#"+c.startOffsetInputId);if(d!=null){d.set("value",b.offset);}d=CY.one("#"+c.endWrapperInputId);if(d!=null){d.set("value",a.elt.id.substring("sv_".length));}d=CY.one("#"+c.endOffsetInputId);if(d!=null){d.set("value",a.offset);}};updateICommentFormSelection=function(h){var i=(h==null)?"":h.text;if(i!=""){var a=i;var f=100;if(i.length>f){var b=i.substring(0,(i.substring(0,f/2)).lastIndexOf(" "));var d=i.substring(i.length-f/2);var e=d.substring(d.indexOf(" "));a=b+" ... "+e;}var c=_convertSelectionFromCCToCS(h.start);var g=_convertSelectionFromCCToCS(h.end);_updateICommentFormSelection(gICommentForm,a,c,g);if(gEdit!=null){_updateICommentFormSelection(gEdit.ids,a,c,g);}positionICommentForm();}};showICommentForm=function(){removeFormErrMsg(gICommentForm.formId);if(!sv_loggedIn){if(CY.one("#"+gICommentForm.nameInputId).get("value")==""){CY.one("#"+gICommentForm.nameInputId).set("value",gPrefs.get("user","name"));}if(CY.one("#"+gICommentForm.emailInputId).get("value")==""){CY.one("#"+gICommentForm.emailInputId).set("value",gPrefs.get("user","email"));}}gIComments.hide();hideToc();positionICommentForm();gICommentForm.overlay.show();CY.one("#"+gICommentForm.titleInputId).focus();};isICommentFormVisible=function(){if(gICommentForm!=null){return gICommentForm.overlay.get("visible");}return false;};positionICommentForm=function(){if(gICommentForm!=null){var c=gICommentForm.overlay;var b=c.get("boundingBox");var a=b.get("offsetHeight");var d=b.get("winHeight");var e=gICommentForm.position;if(a>d){e=[CY.WidgetPositionAlign.BL,CY.WidgetPositionAlign.BL];}c.set("align",{points:e});if(a<=d){c.set("y",c.get("y")+30);}b.setX(b.getX()+gConf.iCommentLeftPadding);}};Preferences=function(){this.prefs={};};Preferences.prototype={init:function(){this._read();},_read:function(){for(var b in gConf.defaultPrefs){this.prefs[b]={};for(var a in gConf.defaultPrefs[b]){var c=null;if(b=="user"&&(a=="name"||a=="email")){c=CY.Cookie.get("user_"+a);}else{c=CY.Cookie.getSub(b,a);}this.prefs[b][a]=(c==null)?gConf.defaultPrefs[b][a]:c;}}},persist:function(b,a,d){var c={path:"/",expires:(new Date()).setFullYear(2100,0,1)};if(b=="user"&&(a=="name"||a=="email")){CY.Cookie.set("user_"+a,d,c);}else{CY.Cookie.setSub(b,a,d,c);}this.prefs[b][a]=d;},get:function(b,a){return this.prefs[b][a];},readDefault:function(b,a){return gConf.defaultPrefs[b][a];},reset:function(d){for(var a=0;a<d.length;a++){var c=d[a];for(var b in gConf.defaultPrefs[c]){this.persist(c,b,gConf.defaultPrefs[c][b]);}}}};_changeIds=function(a,d){if(a.id){a.id=a.id+d;}var b=a.firstChild;while(b!=null){_changeIds(b,d);b=b.nextSibling;}};suffix=0;domDuplicate=function(a){var b=a.cloneNode(true);suffix++;_changeIds(b,"-"+suffix);return b;};getDuplicated=function(a){return document.getElementById(a.id+"-"+suffix);};logSel=function(a){log("text :"+a.text+", start id : "+a.start["elt"].id+" , start offset : "+a.start["offset"]+" , end id : "+a.end["elt"].id+"end offset : "+a.end["offset"]);};log=function(b){var a=document.getElementById("log");a.innerHTML=a.innerHTML+"<li>"+b+"</li>";};urlEncode=function(h){if(!h){return"";}var c=[];for(var f in h){var e=h[f],b=encodeURIComponent(f);var g=typeof e;if(g=="undefined"){c.push(b,"=&");}else{if(g!="function"&&g!="object"){c.push(b,"=",encodeURIComponent(e),"&");}else{if(CY.Lang.isArray(e)){if(e.length){for(var d=0,a=e.length;d<a;d++){c.push(b,"=",encodeURIComponent(e[d]===undefined?"":e[d]),"&");}}else{c.push(b,"=&");}}}}}c.pop();return c.join("");};urlDecode=function(d,c){if(!d||!d.length){return{};}var g={};var b=d.split("&");var e,a,j;for(var f=0,h=b.length;f<h;f++){e=b[f].split("=");a=decodeURIComponent(e[0]);j=decodeURIComponent(e[1]);if(c!==true){if(typeof g[a]=="undefined"){g[a]=j;}else{if(typeof g[a]=="string"){g[a]=[g[a]];g[a].push(j);}else{g[a].push(j);}}}else{g[a]=j;}}return g;};areSortedArraysEqual=function(b,a){if(b.length!=a.length){return false;}for(var d=0,c=b.length;d<c;d++){if(b[d]!=a[d]){return false;}}return true;};quicksort=function(a){_quicksort(a,0,a.length-1);};_quicksort=function(f,g,e){var a,d,c,b;if(e-g==1){if(f[g]>f[e]){b=f[g];f[g]=f[e];f[e]=b;}return;}a=f[parseInt((g+e)/2)];f[parseInt((g+e)/2)]=f[g];f[g]=a;d=g+1;c=e;do{while(d<=c&&f[d]<=a){d++;}while(f[c]>a){c--;}if(d<c){b=f[d];f[d]=f[c];f[c]=b;}}while(d<c);f[g]=f[c];f[c]=a;if(g<c-1){_quicksort(f,g,c-1);}if(c+1<e){_quicksort(f,c+1,e);}};gNewReplyHost=null;gNewReply=null;instanciateNewReplyForm=function(i){if(gNewReply==null){gNewReply={val:{name:gPrefs.get("user","name"),email:gPrefs.get("user","email"),title:"",content:"",tags:""},ids:{name:gPrefs.get("user","name"),email:gPrefs.get("user","email"),title:"",content:"",tags:"",formId:CY.guid(),nameInputId:CY.guid(),emailInputId:CY.guid(),titleInputId:CY.guid(),contentInputId:CY.guid(),keyInputId:CY.guid(),formatInputId:CY.guid(),tagsInputId:CY.guid(),parentCommentId:CY.guid(),addBtnId:CY.guid(),cancelBtnId:CY.guid()},handlers:{}};}gNewReplyHost=i;var a='<hr/><center><div class="c-header-title">'+gettext("New reply")+"</div></center>";var c=gFormHtml.formStart.replace("###",gNewReply.ids["formId"]);if(!sv_loggedIn){c=c+gFormHtml.nameInput.replace("###",gNewReply.ids["nameInputId"])+gFormHtml.emailInput.replace("###",gNewReply.ids["emailInputId"]);}c=c+gFormHtml.titleInput.replace("###",gNewReply.ids["titleInputId"])+gFormHtml.contentInput.replace("###",gNewReply.ids["contentInputId"])+gFormHtml.tagsInput.replace("###",gNewReply.ids["tagsInputId"]);c=c+gFormHtml.hidden.replace("###",gNewReply.ids["keyInputId"]).replace("???","comment_key");c=c+gFormHtml.hidden.replace("###",gNewReply.ids["formatInputId"]).replace("???","format");c=c+gFormHtml.hidden.replace("###",gNewReply.ids["parentCommentId"]).replace("???","reply_to_id");var h=gFormHtml.btns.replace("###",gNewReply.ids["addBtnId"]).replace("???",gNewReply.ids["cancelBtnId"]);gNewReplyHost.overlay.setStdModContent(CY.WidgetStdMod.FOOTER,a+c+h);var f=gNewReplyHost.overlay.getStdModNode(CY.WidgetStdMod.FOOTER);var d=gDb.getComment(i.commentId);var g="Re: ";var e=(gNewReply.val["title"]==""||gNewReply.val["title"].substring(0,g.length)==g)?g+d.title:gNewReply.val["title"];if(!sv_loggedIn){f.one(".n_name").set("value",gNewReply.val["name"]);f.one(".n_email").set("value",gNewReply.val["email"]);}f.one(".n_title").set("value",e);f.one(".n_content").set("value",gNewReply.val["content"]);f.one(".n_tags").set("value",gNewReply.val["tags"]);f.one("#"+gNewReply.ids["parentCommentId"]).set("value",i.commentId);f.one("#"+gNewReply.ids["formatInputId"]).set("value",gConf.defaultCommentFormat);gNewReplyHost.overlay.get("contentBox").one(".c-reply").addClass("displaynone");gNewReply.handlers["addBtnId"]=CY.on("click",onAddNewReplyClick,"#"+gNewReply.ids["addBtnId"]);gNewReply.handlers["cancelBtnId"]=CY.on("click",onCancelNewReplyClick,"#"+gNewReply.ids["cancelBtnId"]);var b=gLayout.getTopICommentsWidth();changeFormFieldsWidth(gNewReply.ids["formId"],b);CY.one("#"+gNewReply.ids["contentInputId"]).focus();};cleanNewReplyForm=function(){if(gNewReplyHost!=null){var a=gNewReplyHost.overlay.getStdModNode(CY.WidgetStdMod.FOOTER);a.all(".comment_input").set("value","");}};cancelNewReplyForm=function(){if(gNewReplyHost!=null){for(var b in gNewReply.handlers){if(gNewReply.handlers[b]!=null){gNewReply.handlers[b].detach();gNewReply.handlers[b]=null;}}gNewReplyHost.overlay.get("contentBox").one(".c-reply").removeClass("displaynone");var a=gNewReplyHost.overlay.getStdModNode(CY.WidgetStdMod.FOOTER);if(!sv_loggedIn){gNewReply.val["name"]=a.one(".n_name").get("value");gNewReply.val["email"]=a.one(".n_email").get("value");}gNewReply.val["title"]=a.one(".n_title").get("value");gNewReply.val["content"]=a.one(".n_content").get("value");gNewReply.val["tags"]=a.one(".n_tags").get("value");a.set("innerHTML","");gNewReplyHost=null;}};onAddNewReplyClick=function(){if(!sv_loggedIn){var b=CY.one("#"+gNewReply.ids["nameInputId"]).get("value");gPrefs.persist("user","name",b);var a=CY.one("#"+gNewReply.ids["emailInputId"]).get("value");gPrefs.persist("user","email",a);}gSync.saveComment(gNewReply.ids["formId"]);};onCancelNewReplyClick=function(){gSync.cancelReply();};IComments=function(){this._c=[];this._a=[];this._nbEndedAnim=0;this._topActiveCommentDbId=null;};IComments.prototype={init:function(b){for(var a=0;a<gConf.iCommentsInitAlloc;a++){this._c.push(new IComment());}},getIComment:function(a){return CY.Array.find(this._c,function(b){return(b.isfetched()&&b.commentId==a);});},insertAfter:function(c,d){var b=CY.Array.map(this._c,function(e){return e.commentId;});var a=CY.Array.indexOf(b,c.id);if(a!=-1){this._c.splice(a+1,0,new IComment());this._c[a+1].fetch(d);return this._c[a+1];}return null;},_remove:function(a){var d=CY.Array.map(a,function(e){return e.commentId;});for(var c=0;c<this._c.length;c++){var b=this._c[c];if(b.isfetched()&&CY.Array.indexOf(d,b.commentId)!=-1){b.unfetch();this._c.push(this._c.splice(c,1)[0]);c--;}}},_getChildren:function(a){return CY.Array.filter(this._c,function(b){return(b.isfetched()&&gDb.isChild(b.commentId,a));});},_getInvisibleChildren:function(a){return CY.Array.filter(this._getChildren(a),function(b){return(!b.isVisible());});},refresh:function(c){var b=this.getIComment(c);var a=this._getInvisibleChildren(c);if(a.length>0){b.showReadRepliesLnk();}else{b.hideReadRepliesLnk();}},remove:function(a){this._remove(this._getChildren(a));},close:function(a){CY.Array.each(this._getChildren(a),function(b){b.hide();});},open:function(a){CY.Array.each(this._getChildren(a),function(b){b.show();});},fetch:function(b){for(var a=0;a<b.length;a++){if(a==this._c.length){this._c.push(new IComment());}this._c[a].fetch(b[a]);}for(var a=b.length;a<this._c.length;a++){this._c[a].unfetch();}},setPosition:function(a){CY.each(this._c,function(b){b.setPosition(a);});},show:function(){CY.each(this._c,function(a){if(a.isfetched()){a.show();}});},hide:function(){this.deactivate();CY.each(this._c,function(a){if(a.commentId!=null){a.hide();}});},setWidth:function(b){var e=null;for(var c=0;c<this._c.length;c++){var a=this._c[c];a.setWidth(b);if(a.commentId!=null&&a.isVisible()){var d=a.getPosition();if(e==null){e=d[1];}d[1]=e;a.setPosition(d);e+=a.getHeight();}}},getTopPosition:function(){for(var b=0;b<this._c.length;b++){var a=this._c[b];if(a.commentId!=null&&a.isVisible()){return a.getPosition();}}return null;},getPosition:function(c){for(var b=0;b<this._c.length;b++){var a=this._c[b];if(a.commentId==c&&a.isVisible()){return a.getPosition();}}return null;},setAnimationToPositions:function(h){this._initAnimations();var c=(gPrefs.get("comments","threadpad")=="1")?gConf.iCommentThreadPadding:0;var g=h;for(var d=0;d<this._c.length;d++){var b=this._c[d];if(b.isfetched&&b.isVisible()){var a=gDb.getPath(gDb.getComment(b.commentId));var f=((a.length-1)*c)+gConf.iCommentLeftPadding;if(g==null){var e=b.getPosition();g=e[1];}this._a.push(b.setAnimationToPosition([f,g]));g+=b.getHeight();}}},setAnimationToPositionsAndFocus:function(h,f,b){this._initAnimations();var a=(gPrefs.get("comments","threadpad")=="1")?gConf.iCommentThreadPadding:0;var j=h;for(var e=0;e<this._c.length;e++){var c=this._c[e];if(c.isfetched&&c.isVisible()){var d=gDb.getPath(gDb.getComment(c.commentId));var g=((d.length-1)*a)+gConf.iCommentLeftPadding;if(j==null){var k=c.getPosition();j=k[1];}if(c.commentId>=f){this._a.push(c.setAnimationToPosition([g,j],f,b));}else{this._a.push(c.setAnimationToPosition([g,j]));}j+=c.getHeight();}}},_initAnimations:function(){this._a=[];this._nbEndedAnim=0;},runAnimations:function(){if(this._a.length==0){gSync.resetAutoContinue("animationRun");}else{CY.each(this._a,function(a){a.run();});}},whenAnimationsEnd:function(){gSync.resume();},whenAnimationsEndFocus:function(){gGETValues=CY.JSON.parse(sv_get_params);if("comment_id_key" in gGETValues){var a=gGETValues.comment_id_key;var b=gDb.getCommentByIdKey(a);if(b!=null){gIComments.getIComment(b.id).overlay.focus();}}gSync.resume();},whenAnimationsEndReply:function(){gGETValues=CY.JSON.parse(sv_get_params);if("comment_id_key" in gGETValues){var a=gGETValues.comment_id_key;var b=gDb.getCommentByIdKey(a);if(b!=null){gSync.showReplyForm(gIComments.getIComment(b.id));}}gSync.resume();},animationsEnded:function(){return((this._a.length==0)||(this._a.length==this._nbEndedAnim));},signalAnimationEnd:function(){this._nbEndedAnim++;},isTopActive:function(a){return((a!=null)&&(this._topActiveCommentDbId==a));},isAnyActive:function(){return(this._topActiveCommentDbId!=null);},activate:function(f){if(this._topActiveCommentDbId!=null){this.deactivate();}var e=gDb.getComment(f);var a=gDb.getPath(e);var c=a[a.length-1];var b=this._getChildren(c.id);CY.Array.each(b,function(g){g.activate();});this._topActiveCommentDbId=c.id;if(gLayout.isInFrame()){var d=gDb.browsingIndex(this._topActiveCommentDbId);parent.$("#browse_by option").each(function(){var g=1+d[this.value];parent.$("#c_browse_indx_"+this.value).html(""+g);});}showScope(c.id);},deactivate:function(){if(this._topActiveCommentDbId!=null){parent.$("#browse_by option").each(function(){parent.$("#c_browse_indx_"+this.value).html("-");});hideScopeAnyway();var a=this._getChildren(this._topActiveCommentDbId);CY.Array.each(a,function(b){b.deactivate();});this._topActiveCommentDbId=null;}},activateVisibleNext:function(){if(this._topActiveCommentDbId!=null){for(var d=0;d<2;d++){var f=(d==0)?0:this._c.length-1;var a=false;for(var e=f;(e>=0)&&e<=(this._c.length-1);){var c=this._c[e];if(c.commentId!=null&&c.isVisible()){a=a||(gDb.isChild(c.commentId,this._topActiveCommentDbId));if(a&&(!gDb.isChild(c.commentId,this._topActiveCommentDbId))){this.activate(c.commentId);return true;}}e=(d==0)?e+1:e-1;}}}return false;},browse:function(b,c){var a=c;if((c=="prev")&&!this.isAnyActive()){a="last";}if((c=="next")&&!this.isAnyActive()){a="first";}return gDb.browse(b,a,this._topActiveCommentDbId);}};CY=null;gPrefs=null;gLayout=null;gDb=null;gIComments=null;gSync=null;gGETValues=null;gConf={iCommentLeftPadding:4,iCommentThreadPadding:12,defaultCommentFormat:"markdown",sliderFixedMin:0.9,sliderFixedMax:0.1,iCommentsInitAlloc:2,defaultPrefs:{text:{style:"text-modern-style"},user:{name:"",email:""},general:{animduration:"0.4"},comments:{threadpad:"1"},layout:{comments_col_width:"25"}}};if(sv_custom_font){gTextStyles={custom:gettext("custom"),modern:gettext("modern"),classic:gettext("classic"),code:gettext("code")};}else{gTextStyles={modern:gettext("modern"),classic:gettext("classic"),code:gettext("code")};}YUI({base:sv_media_url+"/js/lib/yui/"+c_yui_base+"/build/",timeout:10000}).use("cookie","json","overlay","io-form","async-queue","event-mouseenter","anim","collection",function(a){CY=a;gPrefs=new Preferences();gPrefs.init();gLayout=new Layout();gLayout.init();if(sv_withComments){gDb=new Db();gDb.init();gIComments=new IComments();gIComments.init();}gSync=new Sync();gSync.init();CY.on("domready",onDomReady,this);});_reinit=function(a){gIComments.hide();gDb.initComments(a.commentIds);unpaintAllComments();renderCommentScopes();updateFilterResultsCount(a.nbDiscussions,a.nbComments,a.nbReplies);};reinit=function(b){var a=gDb.computeFilterResults(b);_reinit(a);};hideAll=function(){_reinit({commentIds:[],nbDiscussions:0,nbComments:0,nbReplies:0});};updateFilterResultsCount=function(g,e,a){var d=gDb.getCommentsAndRepliesCounts(true);var f=d[0],c=d[1];var b=(e!=0||a!=0)&&(f!=e||c!=a);if(gLayout.isInFrame()){parent.f_updateFilterCountDetailed(b);parent.f_updateFilterCountResult(g,e,a,f,c);}};updateResetFilterResultsCount=function(){var b=gDb.getCommentsAndRepliesCounts(false);var c=b[0],a=b[1];var d=c;updateFilterResultsCount(d,c,a);};renderCommentScopes=function(){for(var a=0;a<gDb.comments.length;a++){var b=gDb.comments[a];paintCommentScope(b);}};onTextMouseUp=function(f){if(readyForAction()){var b=getSelectionInfo();if(b!=null){updateICommentFormSelection(b);if(gEditICommentHost!=null){var g=CY.one("#"+gEdit.ids["changeScopeInputId"]+" input").get("checked");if(g){gEditICommentHost.scrollIntoView();}}}else{var d=f.target;if(d.hasClass("c-c")){var c=CY.Node.getDOMNode(d);var a=getCommentIdsFromClasses(c);if(a.length>0){checkForOpenedDialog(null,function(){gSync.showComments(a,[f.pageX,f.pageY],false);});}}}}};if(safari_mobile){onSelectionChange=onTextMouseUp;}gLastScrollTime=null;checkForAlignement=function(){var a=(new Date()).getTime();if((gLastScrollTime!=null)&&(a-gLastScrollTime)>200){positionICommentForm();gLastScrollTime=null;}};onFrameScroll=function(){gLastScrollTime=(new Date()).getTime();};browse=function(a,b){gSync.browse(a,b);};initialConnect=function(){CY.on("mouseup",onTextMouseUp,"#textcontainer");gTimer=CY.Lang.later(200,this,checkForAlignement,[],true);CY.on("scroll",onFrameScroll,window,this,true);CY.on("resize",onFrameScroll,window,this,true);};preventLinksInText=function(){var a=function(g){var c=g.target;var d=null;while(c!=null&&d==null){c=c.parentNode;d=c.get("href");}if(c!=null&&d!=null){var b=window.location.href;var f=b.indexOf("#");if(f!=-1){b=b.substring(0,f);}if(d.indexOf(b)==-1){window.open(c.get("href"));g.preventDefault();}}};CY.all("#textcontainer a").on("click",a);};onDomReady=function(b){preventLinksInText();var a=new CY.AsyncQueue();a.add({fn:function(){if(gLayout.isInComentSite()){parent.toInitialSize();}if(sv_withComments){instanciateICommentForm();}instanciateToc();},timeout:5},{fn:function(){gGETValues=CY.JSON.parse(sv_get_params);CY.one("#maincontainer").setStyle("display","block");CY.one("#textcontainer").setStyle("display","block");var e=(sv_withComments)?gPrefs.get("layout","comments_col_width"):0;var c=sliderValToPx(e);gLayout.setLeftColumnWidth(c);if(gLayout.isInFrame()){parent.f_initFrame();parent.f_layoutFrames();if(sv_withComments){parent.f_fillTopToolbar();if(hasPerm("can_create_comment")){parent.$("#add_comment_btn").removeClass("initially_hidden");}parent.f_fillFilterTab();parent.f_fillPreferencesTab();var d=CY.JSON.parse(sv_filter_data);parent.f_updateFilterData(d);parent.f_setFilterValue(gGETValues);}parent.f_fillTextPreferencesTab();}if(gLayout.isInComentSite()){parent.$("#c_fullscreen_btn").show();}else{parent.$("#c_fullscreen_btn").hide();}if(gToc.empty){parent.$("#c_toc_btn").hide();}},timeout:5},{fn:function(){if(sv_withComments){reinit(gGETValues);initialConnect();}},timeout:5},{fn:function(){if(gLayout.isInFrame()){parent.f_interfaceUnfreeze();parent.f_removeLoadingMsg();}if("comment_id_key" in gGETValues){var c=gGETValues.comment_id_key;var g=gDb.getCommentByIdKey(c);if(g!=null){var f=gDb.getPath(g);var d=f[f.length-1];var e=gDb.getCommentByIdKey(c);if("comment_op" in gGETValues&&gGETValues.comment_op=="reply"){gSync.showFocusSingleComment(d,e,true);}else{gSync.showFocusSingleComment(d,e,false);}}}if("comments_auto_display" in gGETValues){gSync.showAllComments();}}});a.run();};c_persistPreference=function(b,a,c){gPrefs.persist(b,a,c);};c_readDefaultPreference=function(b,a){return gConf.defaultPrefs[b][a];};c_readPreference=function(b,a){return gPrefs.get(b,a);};c_resetPreferences=function(a){gPrefs.reset(a);};c_applyTextStyle=function(a){CY.use(a);};sliderValToPx=function(d){var c=CY.DOM.winWidth();if(gLayout.isInFrame()){c=parent.$(parent).width();}var b=d/100;b=Math.min(b,gConf.sliderFixedMin);b=Math.max(b,gConf.sliderFixedMax);var a=b*c;return Math.floor(a);};c_setCommentsColWidth=function(c){var a=sliderValToPx(c);gLayout.setLeftColumnWidth(a);var b=gLayout.getTopICommentsWidthFromWidth(a);gIComments.setWidth(b);b+=gLayout.iCommentsRequiredThreadPadding();gICommentForm.overlay.get("boundingBox").setStyle("width",b+"px");changeFormFieldsWidth(gICommentForm.formId,b);document.getElementById("the-toc").style.width=b+"px";if(gNewReply){changeFormFieldsWidth(gNewReply.ids["formId"],b);}if(gEdit){changeFormFieldsWidth(gEdit.ids["formId"],b);}};